<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark - Sprint Analytics & Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Modern Vibrant Blue & Light Blue color palette */
        :root {
            --primary-color: #00ABE4;
            --secondary-color: #0088b8;
            --accent-color: #0066cc;
            --light-bg: #E9F1FA;
            --white-bg: #FFFFFF;
            --sidebar-gradient: linear-gradient(135deg, #00ABE4 0%, #0088b8 100%);
            --header-gradient: linear-gradient(90deg, #00ABE4 0%, #0066cc 100%);
            --card-gradient: linear-gradient(135deg, #FFFFFF 0%, #F8FBFF 100%);
            --primary-gradient: linear-gradient(135deg, #00ABE4 0%, #0088b8 100%);
            --secondary-gradient: linear-gradient(135deg, #0088b8 0%, #0066cc 100%);
            --card-shadow: 0 10px 30px rgba(0, 171, 228, 0.15);
            --hover-shadow: 0 20px 40px rgba(0, 171, 228, 0.25);
            --glow-shadow: 0 0 20px rgba(0, 171, 228, 0.3);
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-white: #FFFFFF;
        }

        body {
            background: linear-gradient(135deg, #E9F1FA 0%, #F0F8FF 50%, #FFFFFF 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(0, 171, 228, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 102, 204, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Modern Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 0;
            background: var(--sidebar-gradient);
            width: 280px;
            box-shadow: 4px 0 30px rgba(0, 171, 228, 0.2);
            backdrop-filter: blur(10px);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            pointer-events: none;
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-logo {
            color: var(--text-white);
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .sidebar-logo i {
            font-size: 2rem;
            color: var(--light-bg);
            animation: pulse 2s infinite;
            filter: drop-shadow(0 0 10px rgba(233, 241, 250, 0.5));
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Custom List Group Styling for Role Selection - Optimized */
        .list-group-item {
            border: 1px solid rgba(0, 171, 228, 0.1);
            background: var(--white-bg);
            transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.2s ease;
            border-radius: 8px !important;
            margin-bottom: 4px;
            position: relative;
        }

        .list-group-item:hover {
            background: rgba(0, 171, 228, 0.05);
            border-color: rgba(0, 171, 228, 0.2);
            transform: translateX(3px);
        }

        .list-group-item.active {
            background: rgba(0, 171, 228, 0.1) !important;
            border-color: var(--primary-color) !important;
            color: var(--primary-color) !important;
            font-weight: 600 !important;
            transform: translateX(4px);
            border-left: 4px solid var(--primary-color) !important;
            box-shadow: 0 3px 10px rgba(0, 171, 228, 0.15);
        }

        .list-group-item i {
            transition: color 0.1s ease;
        }

        .list-group-item.active i {
            color: var(--primary-color) !important;
        }

        /* Enhanced Nav Tabs Styling - Optimized */
        .nav-tabs .nav-link {
            border: 1px solid rgba(0, 171, 228, 0.1);
            background: var(--white-bg);
            color: var(--text-secondary);
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.1s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .nav-tabs .nav-link:hover {
            background: rgba(0, 171, 228, 0.05);
            border-color: rgba(0, 171, 228, 0.2);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            color: var(--text-white) !important;
            font-weight: 600 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 171, 228, 0.25);
        }

        /* Immediate font-weight change for better responsiveness */
        .list-group-item.active,
        .nav-tabs .nav-link.active {
            font-weight: 600 !important;
            transition: none !important;
        }

        .list-group-item.active {
            transition: background-color 0.1s ease, border-color 0.1s ease, transform 0.15s ease !important;
        }

        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 120px);
            padding: 1rem 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            margin: 0.3rem 1rem;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .sidebar .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .sidebar .nav-link:hover::before {
            left: 100%;
        }

        .sidebar .nav-link:hover {
            color: var(--text-white);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            transform: translateX(6px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .sidebar .nav-link.active {
            color: var(--text-white);
            background: var(--secondary-gradient);
            box-shadow: 0 6px 20px rgba(0, 171, 228, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateX(6px);
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar .nav-link i {
            margin-right: 1rem;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        /* Modern Header styles */
        .modern-header {
            position: fixed;
            top: 0;
            right: 0;
            left: 280px;
            height: 70px;
            background: var(--header-gradient);
            z-index: 1030;
            box-shadow: 0 4px 25px rgba(0, 171, 228, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            backdrop-filter: blur(10px);
        }

        .modern-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
            pointer-events: none;
        }

        .header-title {
            color: #fff;
            font-size: 1.4rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.8);
            color: var(--text-white);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: var(--text-white);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Main content styles */
        .main-content {
            margin-left: 280px;
            margin-top: 70px;
            padding: 2rem;
            min-height: calc(100vh - 70px);
        }

        .content-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .header-title {
            color: #fff;
            font-size: 1.4rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced card styles */
        .card {
            background: var(--card-gradient);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 171, 228, 0.1);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }



        .card:hover {
            transform: translateY(-6px);
            box-shadow: var(--hover-shadow);
            border-color: rgba(0, 171, 228, 0.2);
        }

        .clickable-card {
            transition: all 0.3s ease;
        }

        .clickable-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 171, 228, 0.3);
            border-color: rgba(0, 171, 228, 0.4);
        }

        .card-header {
            background: var(--primary-gradient);
            color: var(--text-white);
            border-radius: 20px 20px 0 0 !important;
            border: none;
            padding: 1.25rem 1.5rem;
            position: relative;
            overflow: hidden;
        }



        .card-header h5, .card-header h6 {
            margin: 0;
            font-weight: 600;
            color: var(--text-white) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Input group styling in card headers */
        .card-header .input-group .form-control {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            color: var(--text-primary) !important;
        }

        .card-header .input-group .form-control:focus {
            background: #fff !important;
            border-color: rgba(255, 255, 255, 0.9) !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.3) !important;
        }

        /* Button enhancements */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 171, 228, 0.3);
            color: var(--text-white);
            position: relative;
            overflow: hidden;
        }



        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 171, 228, 0.4);
            background: var(--secondary-gradient);
            color: var(--text-white);
        }



        .btn-outline-success {
            border-radius: 12px;
            border: 2px solid var(--success-color);
            color: var(--success-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, transparent 0%, rgba(16, 185, 129, 0.1) 100%);
            position: relative;
            overflow: hidden;
        }

        .btn-outline-success::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-outline-success:hover::before {
            left: 100%;
        }

        .btn-outline-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            border-color: var(--success-color);
            color: var(--text-white);
        }

        /* Form enhancements */
        .form-control {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background: #fff !important;
            color: var(--text-primary) !important;
            font-weight: 500;
        }

        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 171, 228, 0.25);
            background: #fff !important;
        }

        .form-control::placeholder {
            color: #9ca3af !important;
            font-weight: 400;
        }

        /* Enhanced button visibility */
        .btn-outline-secondary {
            border-radius: 10px;
            border: 2px solid var(--text-white) !important;
            color: var(--text-white) !important;
            background: rgba(255, 255, 255, 0.15) !important;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-outline-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.25) !important;
            border-color: var(--text-white) !important;
            color: var(--text-white) !important;
        }

        /* Special styling for buttons in card headers */
        .card-header .btn-outline-secondary {
            border: 2px solid rgba(255, 255, 255, 0.9) !important;
            color: var(--text-white) !important;
            background: rgba(255, 255, 255, 0.2) !important;
        }

        .card-header .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            border-color: var(--text-white) !important;
            color: var(--text-white) !important;
        }

        .card-header .btn-primary {
            background: rgba(255, 255, 255, 0.2) !important;
            border: 2px solid rgba(255, 255, 255, 0.9) !important;
            color: var(--text-white) !important;
        }

        .card-header .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            border-color: var(--text-white) !important;
            color: var(--text-white) !important;
            transform: translateY(-2px);
        }

        /* Existing enhanced styles */
        .label-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .label-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .action-buttons {
            opacity: 0;
            transition: all 0.3s ease;
        }

        .label-card:hover .action-buttons {
            opacity: 1;
        }

        .loading-spinner {
            display: none;
            margin: 20px auto;
        }

        .error-message {
            display: none;
            margin: 20px auto;
            color: #dc3545;
        }

        .success-message {
            display: none;
            margin: 20px auto;
            color: #198754;
        }

        /* Table enhancements */
        .table {
            background: var(--white-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            border: 1px solid #e2e8f0;
        }

        .table thead th {
            background: var(--primary-gradient);
            color: var(--text-white);
            border: none;
            font-weight: 600;
            padding: 1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .table thead th::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .table:hover thead th::before {
            left: 100%;
        }

        .table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e2e8f0;
        }

        .table tbody tr:hover {
            background: rgba(0, 171, 228, 0.1);
            transform: scale(1.01);
        }

        .table tbody td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }

        /* Alert enhancements */
        .alert {
            border-radius: 12px;
            border: none;
            backdrop-filter: blur(10px);
        }

        .alert-success {
            background: rgba(0, 171, 228, 0.1);
            color: #0c4a6e;
            border-left: 4px solid var(--success-color);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Dark Theme Styles */
        .theme-dark {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .theme-dark .card {
            background-color: #2d2d2d;
            border-color: #404040;
            color: #e0e0e0;
        }

        .theme-dark .card-header {
            background-color: #333333;
            border-color: #404040;
        }

        .theme-dark .modal-content {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }

        .theme-dark .modal-header {
            border-color: #404040;
        }

        .theme-dark .modal-footer {
            border-color: #404040;
        }

        .theme-dark .nav-tabs {
            border-color: #404040;
        }

        .theme-dark .nav-tabs .nav-link {
            color: #b0b0b0;
            border-color: transparent;
        }

        .theme-dark .nav-tabs .nav-link:hover {
            color: #e0e0e0;
            border-color: #404040;
        }

        .theme-dark .nav-tabs .nav-link.active {
            color: #e0e0e0;
            background-color: #2d2d2d;
            border-color: #404040 #404040 #2d2d2d;
        }

        .theme-dark .form-control {
            background-color: #333333;
            border-color: #404040;
            color: #e0e0e0;
        }

        .theme-dark .form-control:focus {
            background-color: #333333;
            border-color: #0d6efd;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .theme-dark .form-select {
            background-color: #333333;
            border-color: #404040;
            color: #e0e0e0;
        }

        .theme-dark .btn-outline-secondary {
            color: #b0b0b0;
            border-color: #404040;
        }

        .theme-dark .btn-outline-secondary:hover {
            color: #e0e0e0;
            background-color: #404040;
            border-color: #404040;
        }

        .theme-dark .text-muted {
            color: #888888 !important;
        }

        .theme-dark .modern-header {
            background: #333333;
        }

        .theme-dark .sidebar {
            background: #252525;
        }

        .theme-dark .content-header {
            background: rgba(45, 45, 45, 0.9);
            border-color: #404040;
        }

        .theme-dark .table {
            color: #e0e0e0;
            background: #2d2d2d;
        }

        .theme-dark .table thead th {
            background: #006fa3;
            color: #E9F1FA;
        }

        .theme-dark .table-bordered {
            border-color: #404040;
        }

        .theme-dark .table-bordered th,
        .theme-dark .table-bordered td {
            border-color: #404040;
        }

        .theme-dark .table-hover tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .theme-dark .alert-success {
            background-color: #1b4332;
            border-color: #2d5a41;
            color: #a7f3d0;
        }

        .theme-dark .alert-danger {
            background-color: #7f1d1d;
            border-color: #991b1b;
            color: #fecaca;
        }

        .theme-dark .alert-info {
            background-color: #006fa3;
            border-color: #00ABE4;
            color: #E9F1FA;
        }

        /* Share Modal Dark Theme */
        .theme-dark .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .theme-dark .btn-success {
            background-color: #198754;
            border-color: #198754;
        }

        .theme-dark .btn-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
            color: #000;
        }

        .theme-dark .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        .theme-dark .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        /* Settings Modal Specific Styles */
        .modal-xl {
            max-width: 1200px;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-card {
            height: 100%;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        /* Compact Mode */
        .compact-mode .card {
            margin-bottom: 1rem;
        }

        .compact-mode .card-body {
            padding: 1rem;
        }

        .compact-mode .performance-card {
            padding: 0.75rem;
        }

        /* Screenshot styles */
        #screenshotPreview {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .screenshot-actions {
            margin-top: 1rem;
        }

        .screenshot-actions .btn {
            margin: 0.25rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-xl {
                max-width: 95%;
            }
            
            .settings-tabs {
                flex-direction: column;
            }

            .screenshot-actions .btn {
                width: 100%;
                margin: 0.25rem 0;
            }
        }

        /* Analytics specific styles */
        .analytics-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .analytics-card .card-title {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .analytics-card .card-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 0;
        }

        #analyticsSection .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #analyticsSection .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
        }

        #analyticsSection .table th {
            border-top: none;
            background-color: #f8f9fa;
            font-weight: 600;
        }

        /* SprintCross horizontal alignment */
    
        #sprintCrossBreakdowns .col-md-4 {
            flex: 1 1 0;
            max-width: 120px;
            min-width: 220px;
        }
       

        /* Enhanced Progress Bar Styling */
        #sprintCrossProgressBar .progress {
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 171, 228, 0.1);
            overflow: hidden;
        }

        #sprintCrossProgressBar .progress-bar {
            border-radius: 15px;
            background: linear-gradient(90deg, #00ABE4 0%, #0088b8 50%, #0066cc 100%);
            box-shadow: 0 0 10px rgba(0, 171, 228, 0.3);
        }

        #sprintCrossProgressText {
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Enhanced Donut Chart Styling */
        #sprintCrossBreakdowns .card {
            border: none;
            box-shadow: var(--card-shadow);
            transition: var(--hover-shadow);
            border-radius: 15px;
            overflow: hidden;
        }
        #sprintCrossBreakdowns {
    display: grid;
    grid-template-columns: repeat(3, minmax(120px, 1fr));
    gap: 0.8rem;
    align-items: start;
    margin-bottom: 1rem;
}
        #sprintCrossBreakdowns .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        #sprintCrossBreakdowns .card-header {
            border: none;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        #sprintCrossBreakdowns .card-body {
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }
        #sprintCrossBreakdowns {
    display: grid;
    grid-template-columns: repeat(3, minmax(120px, 1fr));
    gap: 0.8rem;
    align-items: start;
    margin-bottom: 1rem;
}

#dashboardDonutBreakdowns {
  display: grid;
  grid-template-columns: repeat(3, minmax(120px, 1fr));
  gap: 0.8rem;
  align-items: start;
  margin-bottom: 1rem;
}
#dashboardDonutBreakdowns .card {
  border: none;
  box-shadow: var(--card-shadow);
  border-radius: 15px;
  overflow: hidden;
}
    </style>
</head>
<body>
    <!-- Modern Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-logo">
                <i class="fas fa-project-diagram"></i>
                <span>Spark</span>
            </a>
        </div>
        <div class="sidebar-sticky">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#">
                        <i class="fas fa-chart-line"></i>
                        Sprint Report
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="fas fa-user-clock"></i>
                        Capacity Planning
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="fas fa-lightbulb"></i>
                        Best Practices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="sprintCrossNav">
                        <i class="fas fa-bug"></i>
                        SprintCross
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Modern Header -->
    <header class="modern-header">
        <div class="header-title" id="mainTitle">Sprint Report</div>
        <div class="header-actions">
            <button class="header-btn" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-cog"></i>
                Settings
            </button>
        </div>
    </header>

    <!-- Main content -->
    <main class="main-content">
        <div class="container-fluid">

            <!-- Sprint Report Content (shown by default) -->
            <div id="sprintReportSection">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sprint Report</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="sprintBoardInput" class="form-label">Jira Board URL or Board ID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="sprintBoardInput" 
                                       placeholder="Enter Jira board URL (e.g., https://thoughtspot.atlassian.net/jira/software/c/projects/SCAL/boards/2008) or Board ID (e.g., 2008)">
                                <button class="btn btn-outline-secondary" type="button" id="extractBoardIdBtn">
                                    <i class="fas fa-search"></i> Extract
                                </button>
                            </div>
                           
                            <div id="extractedBoardInfo" class="mt-2" style="display: none;">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> 
                                    <strong>Board ID extracted:</strong> <span id="extractedBoardId"></span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-primary" id="generateSprintReportBtn" disabled>Generate Report</button>
                            <button class="btn btn-outline-success ms-2" id="downloadSprintReportCsvBtn" disabled>
                                <i class="fas fa-download"></i> Download CSV
                            </button>
                            <button class="btn btn-outline-info ms-2" id="shareSprintReportBtn" disabled>
                                <i class="fas fa-share-alt"></i> Share Report
                            </button>
                            <button class="btn btn-outline-primary ms-2" id="generateAIInsightsBtn">
                                <i class="fas fa-brain"></i> AI Insights
                            </button>
                        </div>
                        <div id="sprintReportLoading" class="my-4" style="display:none;">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border text-primary me-2" role="status"></div>
                                <span>Loading sprint report...</span>
                            </div>
                        </div>
                        <div id="sprintReportError" class="alert alert-danger" style="display:none;"></div>
                        <div id="sprintReportTableWrapper" style="display:none;">
                            <h5 class="mb-3">Last 15 Closed Sprints</h5>
                            
                            <!-- Sprint Search/Filter Section -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="sprintSearchInput" 
                                               placeholder="Search sprints by name (e.g., 'CC Sprint', 'Codeflow')">
                                        <button class="btn btn-outline-secondary" type="button" id="clearSprintSearchBtn">
                                            <i class="fas fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <span class="text-muted me-2">Filtered:</span>
                                        <span class="badge bg-primary" id="sprintFilterCount">0</span>
                                        <span class="text-muted ms-2">of</span>
                                        <span class="badge bg-secondary ms-1" id="sprintTotalCount">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr id="sprintReportTableHead"></tr>
                                </thead>
                                <tbody id="sprintReportTableBody"></tbody>
                            </table>
                            
                            <!-- Sprint Charts Section -->
                            <div class="mt-5">
                                <h5 class="mb-3">Sprint Analytics</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Completion Rate Trend</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="completionTrendChart" width="400" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Sprint Scope Changes</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="scopeChangesChart" width="400" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Sprint Velocity Overview</h6>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="velocityChart" width="800" height="300"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>

            <!-- Capacity Planning Content (hidden by default) -->
            <div id="capacityPlanningSection" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Individual Capacity Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="userEmailInput" class="form-label">User Email</label>
                                    <input type="email" class="form-control" id="userEmailInput" 
                                           placeholder="Enter user email (e.g., john.doe@company.com)">
                                    <small class="form-text text-muted">
                                        Enter the email address of the user you want to analyze.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="weeksBackInput" class="form-label">Analysis Period</label>
                                    <select class="form-select" id="weeksBackInput">
                                        <option value="4">Last 4 weeks</option>
                                        <option value="8" selected>Last 8 weeks</option>
                                        <option value="12">Last 12 weeks</option>
                                        <option value="16">Last 16 weeks</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-primary" id="startCapacityAnalysisBtn">
                                <i class="fas fa-analytics"></i> Start Analysis
                            </button>
                            <button class="btn btn-outline-success ms-2" id="exportCapacityReportBtn" disabled>
                                <i class="fas fa-download"></i> Export Report
                            </button>
                            <button class="btn btn-outline-info ms-2" id="shareCapacityReportBtn" disabled>
                                <i class="fas fa-share-alt"></i> Share Report
                            </button>
                        </div>
                        
                        <!-- Progress Section -->
                        <div id="capacityAnalysisProgress" class="my-4" style="display:none;">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Analysis Progress</h6>
                                    <div class="progress mb-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             id="capacityProgressBar" role="progressbar" 
                                             style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                        <span id="capacityProgressText">Initializing analysis...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Section -->
                        <div id="capacityAnalysisError" class="alert alert-danger" style="display:none;"></div>
                        
                        <!-- Results Section -->
                        <div id="capacityAnalysisResults" style="display:none;">
                            <!-- User Performance Overview -->
                            <div class="dashboardDonutBreakdowns">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Overview</h6>
                                            <div class="d-flex align-items-center gap-2">
                                                <a href="#" id="viewInJiraLink" class="btn btn-light btn-sm" target="_blank" style="display: none;">
                                                    <i class="fas fa-external-link-alt me-1"></i>View in JIRA
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-primary mb-1" id="avgCompletedWeek">-</h4>
                                                        <small class="text-muted">Avg Completed/Week</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-success mb-1" id="completionRate">-</h4>
                                                        <small class="text-muted">Completion Rate</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-info mb-1" id="avgHoursWeek">-</h4>
                                                        <small class="text-muted">Avg Hours/Week</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 class="text-warning mb-1" id="totalIssuesAnalyzed">-</h4>
                                                        <small class="text-muted">Total Issues</small>
                                                        <div class="mt-1">
                                                            <a href="#" id="totalIssuesJiraLink" class="btn btn-outline-secondary btn-xs" target="_blank" style="display: none; font-size: 0.7rem;">
                                                                <i class="fas fa-external-link-alt"></i> View All
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Issue Breakdown Section -->
                            <div class="dashboardDonutBreakdowns">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">üìù Issue Types</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="issueTypeBreakdown">
                                                <!-- Issue type breakdown will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">üö® Priority Levels</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="priorityBreakdown">
                                                <!-- Priority breakdown will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">‚úÖ Completion Status</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="completionBreakdown">
                                                <!-- Completion status breakdown will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Weekly Performance Chart -->
                            <div class="">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Weekly Trend</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="weeklyPerformanceChart" width="800" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Insights and Recommendations -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Key Insights</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled" id="insightsList">
                                                <!-- Insights will be populated here -->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Recommendations</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled" id="recommendationsList">
                                                <!-- Recommendations will be populated here -->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Section (hidden by default) -->
            <div id="helpSection" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            Jira Best Practices & Resources
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="list-group" id="roleSelector">
                                    <button type="button" class="list-group-item list-group-item-action active" data-role="all">
                                        <i class="fas fa-users me-2"></i>All Roles
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" data-role="admin">
                                        <i class="fas fa-user-shield me-2"></i>Jira Admin
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" data-role="project-manager">
                                        <i class="fas fa-tasks me-2"></i>Project Manager
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" data-role="scrum-master">
                                        <i class="fas fa-running me-2"></i>Scrum Master
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" data-role="developer">
                                        <i class="fas fa-code me-2"></i>Developer
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" data-role="tester">
                                        <i class="fas fa-bug me-2"></i>QA/Tester
                                    </button>
                                    <button type="button" class="list-group-item list-group-item-action" data-role="business-analyst">
                                        <i class="fas fa-chart-line me-2"></i>Business Analyst
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div id="helpContent">
                                    <!-- Content will be dynamically loaded based on role selection -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SprintCross Section (hidden by default) -->
            <div id="sprintCrossSection" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-bug me-2"></i>
                            SprintCross (Multi-Sprint)
                        </h5>
                        <button id="sprintCrossJiraBtn" class="btn btn-outline-secondary" style="display:none;" target="_blank">
                            <i class="fas fa-external-link-alt me-1"></i> View in JIRA
                                </button>
                            </div>
                    <div class="card-body">
                        <div id="sprintCrossProgressBar" class="mb-3" style="display:none;">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%" id="sprintCrossProgressBarFill"></div>
                            </div>
                            <div class="text-center small text-muted mt-1" id="sprintCrossProgressText">Initializing...</div>
                        </div>
                        <form id="sprintCrossForm" class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="sprintCrossBoardInput" class="form-label">Jira Board URL or Board ID</label>
                                <input type="text" class="form-control" id="sprintCrossBoardInput" placeholder="Enter Jira board URL or Board ID" required>
                </div>
                            <div class="col-md-2 align-self-end">
                                <button type="submit" class="btn btn-primary">Search</button>
                </div>
                        </form>
                        <div id="sprintCrossSummary" class="mb-4"></div>
                        <div id="sprintCrossBreakdowns" style="display:none;">
                            <div>
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white"><i class="fas fa-tasks me-2"></i>Issue Types</div>
                                    <div class="card-body">
                                        <canvas id="sprintCrossTypeChart" width="50" height="50"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card h-100">
                                    <div class="card-header bg-danger text-white"><i class="fas fa-flag me-2"></i>Priority Levels</div>
                                    <div class="card-body">
                                        <canvas id="sprintCrossPriorityChart" width="50" height="50"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white"><i class="fas fa-check-circle me-2"></i>Completion Status</div>
                                    <div class="card-body">
                                        <canvas id="sprintCrossStatusChart" width="50" height="50"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">
                        <i class="fas fa-cog me-2"></i>Application Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Settings Navigation Tabs -->
                    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="jira-config-tab" data-bs-toggle="tab" data-bs-target="#jira-config" type="button" role="tab">
                                <i class="fas fa-server me-2"></i>JIRA Configuration
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-options" type="button" role="tab">
                                <i class="fas fa-download me-2"></i>Export Options
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-config-tab" data-bs-toggle="tab" data-bs-target="#ai-config" type="button" role="tab">
                                <i class="fas fa-brain me-2"></i>AI Configuration
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ui-tab" data-bs-toggle="tab" data-bs-target="#ui-preferences" type="button" role="tab">
                                <i class="fas fa-palette me-2"></i>UI Preferences
                            </button>
                        </li>
                    </ul>

                    <!-- Settings Tab Content -->
                    <div class="tab-content mt-4" id="settingsTabContent">
                        <!-- JIRA Configuration Tab -->
                        <div class="tab-pane fade show active" id="jira-config" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-3">JIRA Connection Settings</h6>
                                    <form id="jiraConfigForm">
                                        <div class="mb-3">
                                            <label for="jiraUrl" class="form-label">JIRA URL</label>
                                            <input type="url" class="form-control" id="jiraUrl" placeholder="https://yourcompany.atlassian.net">
                                            <small class="form-text text-muted">Your JIRA instance URL</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="jiraEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="jiraEmail" placeholder="your.email@company.com">
                                            <small class="form-text text-muted">Your JIRA account email</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="jiraApiToken" class="form-label">API Token</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="jiraApiToken" placeholder="Your JIRA API token">
                                                <button class="btn btn-outline-secondary" type="button" id="toggleApiToken">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" type="button" id="editApiToken" style="display: none;">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                            <div id="tokenStatus" style="display: none;">
                                                <small class="text-success">
                                                    <i class="fas fa-check-circle me-1"></i>API Token configured
                                                    <span class="ms-2">
                                                        <button class="btn btn-sm btn-link p-0" id="showMaskedToken">
                                                            Show masked token
                                                        </button>
                                                    </span>
                                                </small>
                                                <div id="maskedTokenDisplay" style="display: none;" class="mt-2">
                                                    <small class="font-monospace text-muted" id="maskedTokenText"></small>
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">
                                                <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Generate API Token
                                                </a>
                                            </small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-primary" id="testJiraConnection">
                                                <i class="fas fa-plug me-2"></i>Test Connection
                                            </button>
                                            <button type="button" class="btn btn-success" id="saveJiraConfig">
                                                <i class="fas fa-save me-2"></i>Save Configuration
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Connection Status</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="connectionStatus">
                                                <div class="text-muted">
                                                    <i class="fas fa-question-circle me-2"></i>Not tested
                                                </div>
                                            </div>
                                            <div id="jiraUserInfo" style="display: none;">
                                                <h6 class="mt-3">Current User:</h6>
                                                <div id="userDetails"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Options Tab -->
                        <div class="tab-pane fade" id="export-options" role="tabpanel">
                            <h6 class="mb-3">Export Preferences</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">CSV Format Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="csvDelimiter" class="form-label">Delimiter</label>
                                                <select class="form-select" id="csvDelimiter">
                                                    <option value=",">Comma (,)</option>
                                                    <option value=";">Semicolon (;)</option>
                                                    <option value="\t">Tab</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="csvEncoding" class="form-label">Encoding</label>
                                                <select class="form-select" id="csvEncoding">
                                                    <option value="utf-8">UTF-8</option>
                                                    <option value="utf-16">UTF-16</option>
                                                    <option value="iso-8859-1">ISO-8859-1</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeHeaders">
                                                <label class="form-check-label" for="includeHeaders">
                                                    Include column headers
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Auto-Export Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="autoExportEnabled">
                                                <label class="form-check-label" for="autoExportEnabled">
                                                    Enable auto-export
                                                </label>
                                            </div>
                                            <div class="mb-3">
                                                <label for="autoExportFrequency" class="form-label">Frequency</label>
                                                <select class="form-select" id="autoExportFrequency">
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="autoExportEmail" class="form-label">Email reports to</label>
                                                <input type="email" class="form-control" id="autoExportEmail" placeholder="manager@company.com">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Configuration Tab -->
                        <div class="tab-pane fade" id="ai-config" role="tabpanel">
                            <h6 class="mb-3">AI-Powered Insights Configuration</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">OpenAI Integration</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="openaiConfigForm">
                                                <div class="mb-3">
                                                    <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                                                    <div class="input-group">
                                                        <input type="password" class="form-control" id="openaiApiKey" placeholder="sk-...">
                                                        <button class="btn btn-outline-secondary" type="button" id="toggleOpenaiApiKey">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                    <div id="openaiKeyStatus" style="display: none;">
                                                        <small class="text-success">
                                                            <i class="fas fa-check-circle me-1"></i>API Key configured
                                                            <span class="ms-2">
                                                                <button class="btn btn-sm btn-link p-0" id="showMaskedOpenaiKey">
                                                                    Show masked key
                                                                </button>
                                                            </span>
                                                        </small>
                                                        <div id="maskedOpenaiKeyDisplay" style="display: none;" class="mt-2">
                                                            <small class="font-monospace text-muted" id="maskedOpenaiKeyText"></small>
                                                        </div>
                                                    </div>
                                                    <small class="form-text text-muted">
                                                        <a href="https://platform.openai.com/api-keys" target="_blank">
                                                            <i class="fas fa-external-link-alt"></i> Get OpenAI API Key
                                                        </a>
                                                    </small>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="button" class="btn btn-primary" id="testOpenaiConnection">
                                                        <i class="fas fa-plug me-2"></i>Test Connection
                                                    </button>
                                                    <button type="button" class="btn btn-success" id="saveOpenaiConfig">
                                                        <i class="fas fa-save me-2"></i>Save Configuration
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">AI Status</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="aiConnectionStatus">
                                                <div class="text-muted">
                                                    <i class="fas fa-question-circle me-2"></i>Not configured
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">What AI Provides</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled small">
                                                <li><i class="fas fa-check text-success me-2"></i>Sprint performance analysis</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Actionable improvement recommendations</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Scope change pattern insights</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Team velocity optimization tips</li>
                                            </ul>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Powered by GPT-4 for expert-level sprint coaching insights.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- UI Preferences Tab -->
                        <div class="tab-pane fade" id="ui-preferences" role="tabpanel">
                            <h6 class="mb-3">User Interface Preferences</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Theme Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Theme</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="theme" id="lightTheme" value="light" checked>
                                                    <label class="form-check-label" for="lightTheme">
                                                        <i class="fas fa-sun me-2"></i>Light Theme
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="theme" id="darkTheme" value="dark">
                                                    <label class="form-check-label" for="darkTheme">
                                                        <i class="fas fa-moon me-2"></i>Dark Theme
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="theme" id="autoTheme" value="auto">
                                                    <label class="form-check-label" for="autoTheme">
                                                        <i class="fas fa-adjust me-2"></i>Auto (System)
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Dashboard Layout</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="defaultView" class="form-label">Default View</label>
                                                <select class="form-select" id="defaultView">
            
                                                    <option value="sprint-report">Sprint Report</option>
                                                    <option value="capacity-planning">Capacity Planning</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="cardsPerRow" class="form-label">Cards per row</label>
                                                <select class="form-select" id="cardsPerRow">
                                                    <option value="2">2 cards</option>
                                                    <option value="3" selected>3 cards</option>
                                                    <option value="4">4 cards</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="compactMode">
                                                <label class="form-check-label" for="compactMode">
                                                    Compact mode
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Chart Preferences</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="chartType" class="form-label">Default Chart Type</label>
                                                <select class="form-select" id="chartType">
                                                    <option value="line">Line Charts</option>
                                                    <option value="bar">Bar Charts</option>
                                                    <option value="mixed">Mixed Charts</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="chartColors" class="form-label">Color Scheme</label>
                                                <select class="form-select" id="chartColors">
                                                    <option value="default">Default</option>
                                                    <option value="colorful">Colorful</option>
                                                    <option value="monochrome">Monochrome</option>
                                                    <option value="pastel">Pastel</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="animatedCharts" checked>
                                                <label class="form-check-label" for="animatedCharts">
                                                    Animated charts
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveAllSettings">
                        <i class="fas fa-save me-2"></i>Save All Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Modal -->
    <div class="modal fade" id="aiInsightsModal" tabindex="-1" aria-labelledby="aiInsightsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiInsightsModalLabel">
                        <i class="fas fa-brain me-2"></i>ü§ñ AI-Powered Sprint Insights
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- Loading State -->
                    <div id="aiInsightsLoading" class="text-center py-4" style="display:none;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <h6>AI is analyzing your sprint data...</h6>
                        <p class="text-muted">This may take a few seconds</p>
                    </div>
                    
                    <!-- Error State -->
                    <div id="aiInsightsError" class="alert alert-warning" style="display:none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>AI Insights Unavailable</strong>
                                <p class="mb-0">Please configure your OpenAI API key in Settings to enable AI-powered insights.</p>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="$('#settingsModal').modal('show'); $('#aiInsightsModal').modal('hide');">
                                    <i class="fas fa-cog me-1"></i>Configure AI Settings
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="aiInsightsResults" style="display:none;">
                        
                        <!-- Overall Assessment -->
                        <div class="dashboardDonutBreakdowns">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Overall Sprint Health Assessment</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="overallAssessment">
                                            <!-- Overall assessment will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Key Insights -->
                        <div class="dashboardDonutBreakdowns">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fas fa-lightbulb me-2"></i>Actionable Recommendations</h6>
                                <div id="aiInsightsList">
                                    <!-- AI insights will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Key Observations -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Key Observations</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul id="keyObservations" class="mb-0">
                                            <!-- Key observations will be populated here -->
                                        </ul>
                                        <div class="mt-3 text-center">
                                            <small class="text-muted">
                                                <i class="fas fa-robot me-1"></i>Powered by GPT-4 AI
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="regenerateInsightsBtn" style="display:none;">
                        <i class="fas fa-refresh me-2"></i>Regenerate Insights
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Report Modal -->
    <div class="modal fade" id="shareReportModal" tabindex="-1" aria-labelledby="shareReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareReportModalLabel">
                        <i class="fas fa-share-alt me-2"></i>Share Capacity Analysis Report
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Report Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Report Summary</h6>
                        </div>
                        <div class="card-body">
                            <div id="shareSummary">
                                <!-- Summary will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Sharing Options -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Visual Share</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="captureScreenshot">
                                            <i class="fas fa-camera me-2"></i>Capture Screenshot
                                        </button>
                                        <button class="btn btn-success" id="shareScreenshotWhatsApp" disabled>
                                            <i class="fab fa-whatsapp me-2"></i>Share Image to WhatsApp
                                        </button>
                                        <button class="btn btn-info" id="shareScreenshotSlack" disabled>
                                            <i class="fab fa-slack me-2"></i>Share Image to Slack
                                        </button>
                                        <button class="btn btn-warning" id="shareScreenshotEmail" disabled>
                                            <i class="fas fa-envelope me-2"></i>Email with Image
                                        </button>
                                        <button class="btn btn-secondary" id="downloadScreenshot" disabled>
                                            <i class="fas fa-download me-2"></i>Download Image
                                        </button>
                                        <button class="btn btn-outline-primary" id="createVisualShareLink" disabled>
                                            <i class="fas fa-link me-2"></i>Create Visual Share Link
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Quick Share</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="shareToTeams">
                                            <i class="fab fa-microsoft me-2"></i>Share to Microsoft Teams
                                        </button>
                                        <button class="btn btn-success" id="shareToWhatsApp">
                                            <i class="fab fa-whatsapp me-2"></i>Share to WhatsApp
                                        </button>
                                        <button class="btn btn-info" id="shareToSlack">
                                            <i class="fab fa-slack me-2"></i>Share to Slack
                                        </button>
                                        <button class="btn btn-warning" id="shareToEmail">
                                            <i class="fas fa-envelope me-2"></i>Share via Email
                                        </button>
                                        <button class="btn btn-secondary" id="shareToLinkedIn">
                                            <i class="fab fa-linkedin me-2"></i>Share to LinkedIn
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Copy & Share</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="shareFormat" class="form-label">Format</label>
                                        <select class="form-select" id="shareFormat">
                                            <option value="summary">Executive Summary</option>
                                            <option value="detailed">Detailed Report</option>
                                            <option value="metrics">Key Metrics Only</option>
                                            <option value="markdown">Markdown Format</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <button class="btn btn-outline-primary" id="copyToClipboard">
                                            <i class="fas fa-copy me-2"></i>Copy to Clipboard
                                        </button>
                                        <button class="btn btn-outline-secondary ms-2" id="generateShareLink">
                                            <i class="fas fa-link me-2"></i>Generate Share Link
                                        </button>
                                    </div>
                                    <div class="mb-3">
                                        <textarea class="form-control" id="shareText" rows="8" readonly placeholder="Select a format and the shareable text will appear here..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Screenshot Preview Section -->
                    <div class="card mt-3" id="screenshotPreviewCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Screenshot Preview</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <img id="screenshotPreview" class="img-fluid border rounded" style="max-height: 400px;" alt="Report Screenshot">
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Screenshot captured successfully! Use the buttons above to share or download.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Share Link Section -->
                    <div class="card mt-3" id="shareLinkCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Share Link</h6>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" class="form-control" id="shareLink" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copyShareLink">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Share this link to give others access to the report summary (valid for 7 days)
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }



        // Sidebar navigation logic
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                const text = this.textContent.trim();
                
                // Hide all sections first
                document.getElementById('sprintReportSection').style.display = 'none';
                document.getElementById('capacityPlanningSection').style.display = 'none';
                document.getElementById('helpSection').style.display = 'none';
                document.getElementById('sprintCrossSection').style.display = 'none';
                
                if (text === 'Sprint Report') {
                    document.getElementById('sprintReportSection').style.display = 'block';
                    document.getElementById('mainTitle').textContent = 'Sprint Report';
                    trackPageView('Sprint Report');
                } else if (text === 'Capacity Planning') {
                    document.getElementById('capacityPlanningSection').style.display = 'block';
                    document.getElementById('mainTitle').textContent = 'Capacity Planning';
                    trackPageView('Capacity Planning');
                } else if (text === 'Best Practices') {
                    document.getElementById('helpSection').style.display = 'block';
                    document.getElementById('mainTitle').textContent = 'Jira Best Practices & Guidelines';
                    trackPageView('Best Practices');
                    loadHelpContent('all'); // Load default content
                } else if (text === 'SprintCross') {
                    document.getElementById('sprintCrossSection').style.display = 'block';
                    document.getElementById('mainTitle').textContent = 'SprintCross';
                    trackPageView('SprintCross');
                }
            });
        });

        // Sprint Report UI logic
        const sprintBoardInput = document.getElementById('sprintBoardInput');
        const extractBoardIdBtn = document.getElementById('extractBoardIdBtn');
        const extractedBoardInfo = document.getElementById('extractedBoardInfo');
        const generateSprintReportBtn = document.getElementById('generateSprintReportBtn');
        const downloadSprintReportCsvBtn = document.getElementById('downloadSprintReportCsvBtn');
        const shareSprintReportBtn = document.getElementById('shareSprintReportBtn');
        const sprintReportLoading = document.getElementById('sprintReportLoading');
        const sprintReportError = document.getElementById('sprintReportError');
        const sprintReportTableWrapper = document.getElementById('sprintReportTableWrapper');
        const sprintReportTableHead = document.getElementById('sprintReportTableHead');
        const sprintReportTableBody = document.getElementById('sprintReportTableBody');

        let extractedBoardId = null;

        function extractBoardIdFromUrl(input) {
            // If it's already a number, return it
            if (/^\d+$/.test(input.trim())) {
                return input.trim();
            }
            
            // Extract board ID from various Jira URL formats
            const patterns = [
                /\/boards\/(\d+)/,  // Standard board URL
                /rapidView=(\d+)/,  // Legacy URL format
                /board=(\d+)/,      // Alternative format
                /boardId=(\d+)/     // Another alternative
            ];
            
            for (const pattern of patterns) {
                const match = input.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Board ID extraction now handled automatically

        // Extract button removed - now handled automatically
        
        sprintBoardInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // Trigger the Generate Report button click if it's enabled
                if (!generateSprintReportBtn.disabled) {
                    generateSprintReportBtn.click();
                }
            }
        });

        // Clear sprint report data when board input changes
        function clearSprintReportData() {
            // Clear stored data
            currentSprintReportData = null;
            
            // Clear extracted board ID
            extractedBoardId = null;
            document.getElementById('extractedBoardId').textContent = '';
            
            // Hide the board extraction success message
            const boardExtractionSuccess = document.querySelector('.alert-success');
            if (boardExtractionSuccess) {
                boardExtractionSuccess.style.display = 'none';
            }
            
            // Hide/clear all sprint report UI elements
            sprintReportLoading.style.display = 'none';
            sprintReportError.style.display = 'none';
            sprintReportTableWrapper.style.display = 'none';
            
            // Clear table content
            sprintReportTableHead.innerHTML = '';
            sprintReportTableBody.innerHTML = '';
            
            // Disable buttons
            downloadSprintReportCsvBtn.disabled = true;
            shareSprintReportBtn.disabled = true;
                            // Keep AI Insights button enabled for accessibility
            
            // Destroy existing charts if they exist
            if (typeof completionTrendChartInstance !== 'undefined' && completionTrendChartInstance) {
                completionTrendChartInstance.destroy();
                completionTrendChartInstance = null;
            }
            if (typeof scopeChangesChartInstance !== 'undefined' && scopeChangesChartInstance) {
                scopeChangesChartInstance.destroy();
                scopeChangesChartInstance = null;
            }
            if (typeof velocityChartInstance !== 'undefined' && velocityChartInstance) {
                velocityChartInstance.destroy();
                velocityChartInstance = null;
            }
            
            // Clear any progress text
            const progressText = sprintReportLoading.querySelector('p');
            if (progressText) {
                progressText.textContent = '';
            }
            
            console.log('Sprint report data cleared due to board input change');
        }

        // Enable/disable Generate Report button based on input and auto-enable when valid input is entered
        sprintBoardInput.addEventListener('input', function() {
            const input = this.value.trim();
            if (input) {
                const boardId = extractBoardIdFromUrl(input);
                generateSprintReportBtn.disabled = !boardId;
                if (boardId) {
                    sprintReportError.style.display = 'none';
                }
            } else {
                generateSprintReportBtn.disabled = true;
            }
            
            
            // Clear sprint report data when user starts typing/changing the board input
            if (currentSprintReportData || sprintReportTableWrapper.style.display !== 'none') {
                clearSprintReportData();
            }
        });

        generateSprintReportBtn.addEventListener('click', async function() {
            // Extract board ID automatically from input
            const input = sprintBoardInput.value.trim();
            if (!input) {
                alert('Please enter a Jira board URL or board ID');
                return;
            }
            
            const extractedBoardId = extractBoardIdFromUrl(input);
            if (!extractedBoardId) {
                alert('Could not extract board ID from the provided input. Please check the URL format or enter a valid board ID.');
                return;
            }
            
            sprintReportLoading.style.display = 'block';
            sprintReportError.style.display = 'none';
            sprintReportTableWrapper.style.display = 'none';
            downloadSprintReportCsvBtn.disabled = true;
            
            // Clear previous data
            let streamingReport = [];
            let progressText = sprintReportLoading.querySelector('p') || document.createElement('p');
            if (!sprintReportLoading.querySelector('p')) {
                sprintReportLoading.appendChild(progressText);
            }
            progressText.textContent = 'Starting sprint analysis...';
            
            try {
                // Use EventSource for streaming
                const eventSource = new EventSource(`/api/jira_sprint_report_stream?board_id=${extractedBoardId}`);
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        switch(data.type) {
                            case 'start':
                                progressText.textContent = `Starting analysis of ${data.total_expected} sprints...`;
                                break;
                                
                            case 'progress':
                                if (data.current && data.total) {
                                    progressText.textContent = `${data.message} (${data.current}/${data.total})`;
                                } else {
                                    progressText.textContent = data.message;
                                }
                                break;
                                
                            case 'sprint_result':
                                // Add sprint result to our growing report
                                streamingReport.push(data.data);
                                
                                // Just show progress, don't update table yet
                                progressText.textContent = `Analyzed sprint: ${data.data['Sprint Name']} (${streamingReport.length}/15 completed)`;
                                break;
                                
                            case 'complete':
                                progressText.textContent = 'Analysis complete! Rendering results...';
                                eventSource.close();
                                
                                // Now render the complete table with all results
                                renderSprintReportTable(streamingReport);
                                sprintReportTableWrapper.style.display = '';
                                
                                // Enable buttons
                                downloadSprintReportCsvBtn.disabled = false;
                                shareSprintReportBtn.disabled = false;
                                document.getElementById('generateAIInsightsBtn').disabled = false;
                                
                                // Store final sprint report data for sharing
                                currentSprintReportData = {
                                    report: streamingReport,
                                    board_id: extractedBoardId,
                                    generated_at: new Date().toISOString(),
                                    type: 'sprint_report'
                                };
                                
                                // Hide loading after a brief delay
                                setTimeout(() => {
                                    sprintReportLoading.style.display = 'none';
                                }, 1000);
                                break;
                                
                            case 'error':
                                throw new Error(data.error);
                        }
                    } catch (parseError) {
                        console.error('Error parsing streaming data:', parseError);
                        progressText.textContent = 'Error processing streaming data';
                    }
                };
                
                eventSource.onerror = function(event) {
                    console.error('EventSource error:', event);
                    eventSource.close();
                    sprintReportError.textContent = 'Connection error during streaming. Please try again.';
                    sprintReportError.style.display = 'block';
                    sprintReportLoading.style.display = 'none';
                };
                
            } catch (err) {
                sprintReportError.textContent = err.message || 'Failed to start sprint report streaming.';
                sprintReportError.style.display = 'block';
                sprintReportLoading.style.display = 'none';
            }
        });

        downloadSprintReportCsvBtn.addEventListener('click', async function() {
            // Extract board ID automatically from input
            const input = sprintBoardInput.value.trim();
            if (!input) {
                alert('Please enter a Jira board URL or board ID');
                return;
            }
            
            const extractedBoardId = extractBoardIdFromUrl(input);
            if (!extractedBoardId) {
                alert('Could not extract board ID from the provided input. Please check the URL format or enter a valid board ID.');
                return;
            }
            
            // Store reference to button for proper state management
            const button = this;
            const originalHTML = button.innerHTML;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
                
                // Create download URL
                const downloadUrl = `/api/jira_sprint_report?board_id=${extractedBoardId}&format=csv`;
                console.log('Downloading CSV from:', downloadUrl);
                
                // Use fetch to handle the download properly
                const response = await fetch(downloadUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Get the CSV content
                const csvContent = await response.text();
                
                // Create a blob and download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                
                // Create temporary download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `sprint_report_board_${extractedBoardId}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                
                // Add a small delay to ensure download starts
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('CSV download completed successfully');
                
                // Show success state briefly
                button.innerHTML = '<i class="fas fa-check"></i> Downloaded!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-success');
                
                // Restore original state after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-success');
                    button.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('CSV download failed:', error);
                alert(`Failed to download CSV: ${error.message}`);
                
                // Restore button state immediately on error
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        });

        // Store the original sprint report data for filtering
        let originalSprintReportData = [];

        function renderSprintReportTable(report) {
            if (!Array.isArray(report) || !report.length) {
                sprintReportTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No data available.</td></tr>';
                sprintReportTableHead.innerHTML = '';
                sprintReportTableWrapper.style.display = '';
                return;
            }
            
            // Store the original data for filtering
            originalSprintReportData = [...report];
            
            // Define the desired column order
            const headers = [
                "Sprint Name",
                "Start Date",
                "End Date",
                "Initial Planned",
                "Completed",
                "Not Completed",
                "Added During Sprint",
                "Removed During Sprint",
                "Completion %",
                "Insight",
                "Status"
            ];
            
            // Render the table with all data initially
            renderFilteredSprintTable(report, headers);
            
            // Update filter counts
            updateSprintFilterCounts(report.length, report.length);
            
            // Render charts after table is displayed
            renderSprintCharts(report);
        }

        function renderFilteredSprintTable(filteredReport, headers) {
            sprintReportTableHead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            sprintReportTableBody.innerHTML = filteredReport.map(row =>
                `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`
            ).join('');
            sprintReportTableWrapper.style.display = '';
        }

        function updateSprintFilterCounts(filteredCount, totalCount) {
            document.getElementById('sprintFilterCount').textContent = filteredCount;
            document.getElementById('sprintTotalCount').textContent = totalCount;
        }

        function filterSprintReport(searchTerm) {
            if (!originalSprintReportData.length) return;
            
            const headers = [
                "Sprint Name",
                "Start Date",
                "End Date",
                "Initial Planned",
                "Completed",
                "Not Completed",
                "Added During Sprint",
                "Removed During Sprint",
                "Completion %",
                "Insight",
                "Status"
            ];
            
            let filteredData = originalSprintReportData;
            
            if (searchTerm && searchTerm.trim() !== '') {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredData = originalSprintReportData.filter(row => {
                    const sprintName = row["Sprint Name"] ? row["Sprint Name"].toLowerCase() : '';
                    return sprintName.includes(searchLower);
                });
            }
            
            // Render the filtered table
            renderFilteredSprintTable(filteredData, headers);
            
            // Update filter counts
            updateSprintFilterCounts(filteredData.length, originalSprintReportData.length);
            
            // Re-render charts with filtered data
            renderSprintCharts(filteredData);
        }

        // Store chart instances to manage them
        let completionTrendChartInstance = null;
        let scopeChangesChartInstance = null;
        let velocityChartInstance = null;

        function renderSprintCharts(report) {
            // Destroy existing charts if they exist
            if (completionTrendChartInstance) {
                completionTrendChartInstance.destroy();
                completionTrendChartInstance = null;
            }
            if (scopeChangesChartInstance) {
                scopeChangesChartInstance.destroy();
                scopeChangesChartInstance = null;
            }
            if (velocityChartInstance) {
                velocityChartInstance.destroy();
                velocityChartInstance = null;
            }

            // Prepare data for charts
            const sprintNames = report.map(r => r["Sprint Name"].substring(0, 15) + "..."); // Truncate long names
            const completionRates = report.map(r => parseFloat(r["Completion %"].replace('%', '')));
            const completed = report.map(r => r["Completed"]);
            const notCompleted = report.map(r => r["Not Completed"]);
            const addedDuring = report.map(r => r["Added During Sprint"]);
            const removedDuring = report.map(r => r["Removed During Sprint"]);

            // Chart 1: Completion Rate Trend
            const ctx1 = document.getElementById('completionTrendChart').getContext('2d');
            completionTrendChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: sprintNames,
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: completionRates,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                   
                }
            });

            // Chart 2: Sprint Scope Changes
            const ctx2 = document.getElementById('scopeChangesChart').getContext('2d');
            scopeChangesChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: sprintNames,
                    datasets: [{
                        label: 'Added During Sprint',
                        data: addedDuring,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Removed During Sprint',
                        data: removedDuring,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Chart 3: Sprint Velocity Overview
            const ctx3 = document.getElementById('velocityChart').getContext('2d');
            velocityChartInstance = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: sprintNames,
                    datasets: [{
                        label: 'Completed',
                        data: completed,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Not Completed',
                        data: notCompleted,
                        backgroundColor: 'rgba(255, 206, 86, 0.8)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                   
                }
            });
        }

        // Capacity Planning UI Logic
        const userEmailInput = document.getElementById('userEmailInput');
        const weeksBackInput = document.getElementById('weeksBackInput');
        const startCapacityAnalysisBtn = document.getElementById('startCapacityAnalysisBtn');
        const exportCapacityReportBtn = document.getElementById('exportCapacityReportBtn');
        const capacityAnalysisProgress = document.getElementById('capacityAnalysisProgress');
        const capacityProgressBar = document.getElementById('capacityProgressBar');
        const capacityProgressText = document.getElementById('capacityProgressText');
        const capacityAnalysisError = document.getElementById('capacityAnalysisError');
        const capacityAnalysisResults = document.getElementById('capacityAnalysisResults');
        
        let currentCapacityTaskId = null;
        let capacityProgressInterval = null;
        let weeklyPerformanceChartInstance = null;

        // Email validation
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Start capacity analysis
        startCapacityAnalysisBtn.addEventListener('click', async function() {
            const userEmail = userEmailInput.value.trim();
            const weeksBack = parseInt(weeksBackInput.value);
            
            if (!userEmail) {
                alert('Please enter a user email');
                return;
            }
            
            if (!isValidEmail(userEmail)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Reset UI
            capacityAnalysisError.style.display = 'none';
            capacityAnalysisResults.style.display = 'none';
            exportCapacityReportBtn.disabled = true;
            
            try {
                // Start analysis
                const response = await fetch('/api/capacity/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_email: userEmail,
                        weeks_back: weeksBack
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start analysis');
                }
                
                currentCapacityTaskId = data.task_id;
                
                // Show progress
                capacityAnalysisProgress.style.display = 'block';
                startCapacityAnalysisBtn.disabled = true;
                
                // Start polling for progress
                startCapacityProgressPolling();
                
            } catch (error) {
                console.error('Error starting capacity analysis:', error);
                capacityAnalysisError.textContent = error.message;
                capacityAnalysisError.style.display = 'block';
            }
        });

        // Progress polling
        function startCapacityProgressPolling() {
            if (capacityProgressInterval) {
                clearInterval(capacityProgressInterval);
            }
            
            capacityProgressInterval = setInterval(async () => {
                if (!currentCapacityTaskId) return;
                
                try {
                    const response = await fetch(`/api/capacity/progress/${currentCapacityTaskId}`);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to get progress');
                    }
                    
                    // Update progress bar
                    capacityProgressBar.style.width = `${data.progress}%`;
                    capacityProgressBar.setAttribute('aria-valuenow', data.progress);
                    
                    // Update progress text
                    if (data.status === 'fetching_data') {
                        capacityProgressText.textContent = 'Fetching user data from JIRA...';
                    } else if (data.status === 'in_progress') {
                        capacityProgressText.textContent = 'Analyzing performance patterns...';
                    } else if (data.status === 'completed') {
                        capacityProgressText.textContent = 'Analysis completed!';
                        clearInterval(capacityProgressInterval);
                        capacityAnalysisProgress.style.display = 'none';
                        startCapacityAnalysisBtn.disabled = false;
                        
                        // Display results
                        displayCapacityResults(data.result);
                        exportCapacityReportBtn.disabled = false;
                        shareCapacityReportBtn.disabled = false;
                        currentReportData = data.result;
                        
                    } else if (data.status === 'error') {
                        clearInterval(capacityProgressInterval);
                        capacityAnalysisProgress.style.display = 'none';
                        startCapacityAnalysisBtn.disabled = false;
                        capacityAnalysisError.textContent = data.error || 'Analysis failed';
                        capacityAnalysisError.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error polling progress:', error);
                    clearInterval(capacityProgressInterval);
                    capacityAnalysisProgress.style.display = 'none';
                    startCapacityAnalysisBtn.disabled = false;
                    capacityAnalysisError.textContent = 'Failed to get analysis progress';
                    capacityAnalysisError.style.display = 'block';
                }
            }, 2000); // Poll every 2 seconds
        }

        // Display capacity analysis results
        function displayCapacityResults(result) {
            // Ensure results section is visible before updating contents
            capacityAnalysisResults.style.display = 'block';
            // Defensive: check for required elements and log if missing
            const avgCompletedWeekEl = document.getElementById('avgCompletedWeek');
            const completionRateEl = document.getElementById('completionRate');
            const avgHoursWeekEl = document.getElementById('avgHoursWeek');
            const totalIssuesAnalyzedEl = document.getElementById('totalIssuesAnalyzed');
            if (!avgCompletedWeekEl) { console.error('Missing element: avgCompletedWeek'); return; }
            if (!completionRateEl) { console.error('Missing element: completionRate'); return; }
            if (!avgHoursWeekEl) { console.error('Missing element: avgHoursWeek'); return; }
            if (!totalIssuesAnalyzedEl) { console.error('Missing element: totalIssuesAnalyzed'); return; }
            
            avgCompletedWeekEl.textContent = result.metrics.avg_completed_per_week.toFixed(1);
            completionRateEl.textContent = (result.metrics.completion_rate * 100).toFixed(1) + '%';
            avgHoursWeekEl.textContent = result.metrics.avg_hours_per_week.toFixed(1) + 'h';
            totalIssuesAnalyzedEl.textContent = result.total_issues_analyzed;
            
            // Update JIRA links
            const jiraLink = document.getElementById('viewInJiraLink');
            const totalIssuesJiraLink = document.getElementById('totalIssuesJiraLink');
            
            if (result.jira_link) {
                // Main JIRA link in header
                jiraLink.href = result.jira_link;
                jiraLink.style.display = 'inline-block';
                jiraLink.title = `JQL: ${result.jql_query}`;
                
                // Total issues JIRA link
                totalIssuesJiraLink.href = result.jira_link;
                totalIssuesJiraLink.style.display = 'inline-block';
                totalIssuesJiraLink.title = `View all ${result.total_issues_analyzed} issues in JIRA`;
            }
            
            // Update issue breakdown
            displayIssueBreakdown(result.issue_breakdown);
            
            // Update insights
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = result.insights.map(insight => 
                `<li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>${insight}</li>`
            ).join('');
            
            // Update recommendations
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = result.recommendations.map(rec => 
                `<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>${rec}</li>`
            ).join('');
            
            // Render weekly performance chart
            renderWeeklyPerformanceChart(result.weekly_summary);
        }

        // Display issue breakdown
        function displayIssueBreakdown(breakdown) {
            // Issue type breakdown
            const issueTypeDiv = document.getElementById('issueTypeBreakdown');
            const sortedTypes = Object.entries(breakdown.by_type)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Show top 5
            
            issueTypeDiv.innerHTML = sortedTypes.map(([type, count]) => {
                const percentage = ((count / breakdown.total_issues) * 100).toFixed(1);
                const iconClass = getIssueTypeIcon(type);
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="${iconClass} me-2"></i>${type}</span>
                        <div>
                            <span class="badge bg-primary">${count}</span>
                            <small class="text-muted ms-1">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Priority breakdown
            const priorityDiv = document.getElementById('priorityBreakdown');
            const sortedPriorities = Object.entries(breakdown.by_priority)
                .sort((a, b) => b[1] - a[1]);
            
            priorityDiv.innerHTML = sortedPriorities.map(([priority, count]) => {
                const percentage = ((count / breakdown.total_issues) * 100).toFixed(1);
                const badgeClass = getPriorityBadgeClass(priority);
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${priority}</span>
                        <div>
                            <span class="badge ${badgeClass}">${count}</span>
                            <small class="text-muted ms-1">(${percentage}%)</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Completion status breakdown
            const completionDiv = document.getElementById('completionBreakdown');
            const completion = breakdown.by_completion;
            
            completionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fas fa-check-circle me-2 text-success"></i>Completed</span>
                    <span class="badge bg-success">${completion.completed}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fas fa-play-circle me-2 text-warning"></i>In Progress</span>
                    <span class="badge bg-warning text-dark">${completion.in_progress}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fas fa-pause-circle me-2 text-secondary"></i>Not Started</span>
                    <span class="badge bg-secondary">${completion.not_started}</span>
                </div>
            `;
        }

        // Helper function to get issue type icon
        function getIssueTypeIcon(issueType) {
            const iconMap = {
                'Task': 'fas fa-tasks',
                'Bug': 'fas fa-bug',
                'Story': 'fas fa-book',
                'Epic': 'fas fa-flag',
                'Sub-task': 'fas fa-list-ul',
                'Improvement': 'fas fa-arrow-up',
                'New Feature': 'fas fa-plus',
                'Technical task': 'fas fa-cogs'
            };
            return iconMap[issueType] || 'fas fa-ticket-alt';
        }

        // Helper function to get priority badge class
        function getPriorityBadgeClass(priority) {
            const classMap = {
                'Highest': 'bg-danger',
                'High': 'bg-warning',
                'P0': 'bg-danger',
                'P1': 'bg-warning text-dark',
                'P2': 'bg-info',
                'P3': 'bg-secondary',
                'P4': 'bg-light text-dark',
                'Medium': 'bg-info',
                'Low': 'bg-secondary',
                'Lowest': 'bg-light text-dark',
                'No Priority': 'bg-light text-dark'
            };
            return classMap[priority] || 'bg-primary';
        }

        // Render weekly performance chart
        function renderWeeklyPerformanceChart(weeklySummary) {
            // Destroy existing chart if it exists
            if (weeklyPerformanceChartInstance) {
                weeklyPerformanceChartInstance.destroy();
                weeklyPerformanceChartInstance = null;
            }
            
            // Prepare data
            const weeks = weeklySummary.map(w => w.week);
            const completed = weeklySummary.map(w => w.completed);
            const started = weeklySummary.map(w => w.started);
            const hoursSpent = weeklySummary.map(w => w.hours_spent);
            
            const ctx = document.getElementById('weeklyPerformanceChart').getContext('2d');
            weeklyPerformanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Completed Issues',
                        data: completed,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Started Issues',
                        data: started,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Hours Spent',
                        data: hoursSpent,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Issues'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Hours'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'Hours Spent') {
                                        label += context.parsed.y.toFixed(1) + 'h';
                                    } else {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Share capacity report
        const shareCapacityReportBtn = document.getElementById('shareCapacityReportBtn');
        let currentReportData = null;
        let currentSprintReportData = null;
        let analyticsSessionId = null;
        let analyticsCharts = {};

        shareCapacityReportBtn.addEventListener('click', function() {
            if (!currentCapacityTaskId || !currentReportData) {
                alert('No analysis results to share');
                return;
            }
            
            // Populate share modal with report data
            populateShareModal(currentReportData);
            
            // Show the share modal
            const shareModal = new bootstrap.Modal(document.getElementById('shareReportModal'));
            shareModal.show();
        });

        shareSprintReportBtn.addEventListener('click', function() {
            if (!currentSprintReportData) {
                alert('No sprint report data to share');
                return;
            }
            
            // Populate share modal with sprint report data
            populateSprintShareModal(currentSprintReportData);
            
            // Show the share modal
            const shareModal = new bootstrap.Modal(document.getElementById('shareReportModal'));
            shareModal.show();
        });

        // Export capacity report
        exportCapacityReportBtn.addEventListener('click', async function() {
            if (!currentCapacityTaskId) {
                alert('No analysis results to export');
                return;
            }
            
            const button = this;
            const originalHTML = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
                
                // Get export settings
                const exportSettings = JSON.parse(localStorage.getItem('exportSettings') || '{}');
                const delimiter = exportSettings.delimiter || ',';
                const encoding = exportSettings.encoding || 'utf-8';
                const includeHeaders = exportSettings.includeHeaders !== false; // default true
                
                // Build URL with parameters
                const params = new URLSearchParams({
                    delimiter: delimiter,
                    encoding: encoding,
                    include_headers: includeHeaders.toString()
                });
                
                const response = await fetch(`/api/capacity/export/${currentCapacityTaskId}?${params.toString()}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Export failed');
                }
                
                // Get the CSV content
                const csvContent = await response.text();
                
                // Create download
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `capacity_analysis_${userEmailInput.value.split('@')[0]}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success
                button.innerHTML = '<i class="fas fa-check"></i> Exported!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-success');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-success');
                    button.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Export failed:', error);
                alert(`Failed to export report: ${error.message}`);
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        });

        // Share functionality
        function populateShareModal(reportData) {
            // Populate summary
            const shareSummary = document.getElementById('shareSummary');
            shareSummary.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>User:</strong> ${reportData.user_email}</p>
                        <p><strong>Analysis Period:</strong> ${reportData.analysis_period}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Completion Rate:</strong> ${(reportData.metrics.completion_rate * 100).toFixed(1)}%</p>
                        <p><strong>Avg Completed/Week:</strong> ${reportData.metrics.avg_completed_per_week.toFixed(1)}</p>
                        <p><strong>Total Issues:</strong> ${reportData.total_issues_analyzed}</p>
                    </div>
                </div>
            `;
            
            // Update share format when changed
            updateShareText(reportData);
        }

        function updateShareText(reportData) {
            const format = document.getElementById('shareFormat').value;
            const shareText = document.getElementById('shareText');
            
            let content = '';
            
            switch (format) {
                case 'summary':
                    content = generateExecutiveSummary(reportData);
                    break;
                case 'detailed':
                    content = generateDetailedReport(reportData);
                    break;
                case 'metrics':
                    content = generateMetricsOnly(reportData);
                    break;
                case 'markdown':
                    content = generateMarkdownReport(reportData);
                    break;
            }
            
            shareText.value = content;
        }

        function generateExecutiveSummary(data) {
            return `üéØ CAPACITY ANALYSIS SUMMARY

üë§ User: ${data.user_email}
üìÖ Period: ${data.analysis_period}
‚≠ê Overall Rating: ${data.overall_rating}

üìä KEY METRICS:
‚Ä¢ Completion Rate: ${(data.metrics.completion_rate * 100).toFixed(1)}%
‚Ä¢ Avg Issues Completed/Week: ${data.metrics.avg_completed_per_week.toFixed(1)}
‚Ä¢ Total Issues Analyzed: ${data.total_issues_analyzed}
‚Ä¢ Avg Hours/Week: ${data.metrics.avg_hours_per_week.toFixed(1)}h

üí° TOP INSIGHTS:
${data.insights.slice(0, 3).map(insight => `‚Ä¢ ${insight.replace(/[^\w\s.,!?-]/g, '')}`).join('\n')}

üéØ KEY RECOMMENDATIONS:
${data.recommendations.slice(0, 2).map(rec => `‚Ä¢ ${rec.replace(/[^\w\s.,!?-]/g, '')}`).join('\n')}

Generated by JIRA Capacity Planning Tool`;
        }

        function generateDetailedReport(data) {
            const breakdown = data.issue_breakdown;
            return `üìã DETAILED CAPACITY ANALYSIS REPORT

üë§ USER INFORMATION:
‚Ä¢ Email: ${data.user_email}
‚Ä¢ Analysis Period: ${data.analysis_period}
‚Ä¢ Overall Performance: ${data.overall_rating}

üìä PERFORMANCE METRICS:
‚Ä¢ Total Issues Analyzed: ${data.total_issues_analyzed}
‚Ä¢ Completion Rate: ${(data.metrics.completion_rate * 100).toFixed(1)}%
‚Ä¢ Average Completed per Week: ${data.metrics.avg_completed_per_week.toFixed(1)}
‚Ä¢ Average Started per Week: ${data.metrics.avg_started_per_week.toFixed(1)}
‚Ä¢ Average Hours per Week: ${data.metrics.avg_hours_per_week.toFixed(1)}h
‚Ä¢ Total Hours Tracked: ${data.metrics.total_hours.toFixed(1)}h

üè∑Ô∏è ISSUE BREAKDOWN:
Issue Types:
${Object.entries(breakdown.by_type).map(([type, count]) => 
    `‚Ä¢ ${type}: ${count} (${((count/breakdown.total_issues)*100).toFixed(1)}%)`
).join('\n')}

Priority Distribution:
${Object.entries(breakdown.by_priority).map(([priority, count]) => 
    `‚Ä¢ ${priority}: ${count} (${((count/breakdown.total_issues)*100).toFixed(1)}%)`
).join('\n')}

Completion Status:
‚Ä¢ Completed: ${breakdown.by_completion.completed}
‚Ä¢ In Progress: ${breakdown.by_completion.in_progress}
‚Ä¢ Not Started: ${breakdown.by_completion.not_started}

üí° INSIGHTS:
${data.insights.map(insight => `‚Ä¢ ${insight.replace(/[^\w\s.,!?-]/g, '')}`).join('\n')}

üéØ RECOMMENDATIONS:
${data.recommendations.map(rec => `‚Ä¢ ${rec.replace(/[^\w\s.,!?-]/g, '')}`).join('\n')}

üìà WEEKLY PERFORMANCE:
${data.weekly_summary.map(week => 
    `Week ${week.week}: ${week.completed} completed, ${week.started} started, ${week.hours_spent}h`
).join('\n')}

Generated by JIRA Capacity Planning Tool
Report Date: ${new Date().toLocaleDateString()}`;
        }

        function generateMetricsOnly(data) {
            return `üìä CAPACITY METRICS - ${data.user_email}

üéØ PERFORMANCE SUMMARY (${data.analysis_period}):
‚Ä¢ Overall Rating: ${data.overall_rating}
‚Ä¢ Completion Rate: ${(data.metrics.completion_rate * 100).toFixed(1)}%
‚Ä¢ Issues Analyzed: ${data.total_issues_analyzed}

‚ö° WEEKLY AVERAGES:
‚Ä¢ Completed: ${data.metrics.avg_completed_per_week.toFixed(1)} issues
‚Ä¢ Started: ${data.metrics.avg_started_per_week.toFixed(1)} issues  
‚Ä¢ Time Spent: ${data.metrics.avg_hours_per_week.toFixed(1)} hours

üìà TOTALS:
‚Ä¢ Total Completed: ${data.metrics.total_completed}
‚Ä¢ Total Started: ${data.metrics.total_started}
‚Ä¢ Total Hours: ${data.metrics.total_hours.toFixed(1)}h

Generated: ${new Date().toLocaleDateString()}`;
        }

        function generateMarkdownReport(data) {
            const breakdown = data.issue_breakdown;
            return `# üìã Capacity Analysis Report

## üë§ User Information
- **Email:** ${data.user_email}
- **Analysis Period:** ${data.analysis_period}
- **Overall Rating:** ${data.overall_rating}

## üìä Performance Metrics
| Metric | Value |
|--------|-------|
| Total Issues Analyzed | ${data.total_issues_analyzed} |
| Completion Rate | ${(data.metrics.completion_rate * 100).toFixed(1)}% |
| Avg Completed/Week | ${data.metrics.avg_completed_per_week.toFixed(1)} |
| Avg Started/Week | ${data.metrics.avg_started_per_week.toFixed(1)} |
| Avg Hours/Week | ${data.metrics.avg_hours_per_week.toFixed(1)}h |

## üè∑Ô∏è Issue Breakdown

### By Type
${Object.entries(breakdown.by_type).map(([type, count]) => 
    `- **${type}:** ${count} (${((count/breakdown.total_issues)*100).toFixed(1)}%)`
).join('\n')}

### By Priority
${Object.entries(breakdown.by_priority).map(([priority, count]) => 
    `- **${priority}:** ${count} (${((count/breakdown.total_issues)*100).toFixed(1)}%)`
).join('\n')}

### By Status
- **Completed:** ${breakdown.by_completion.completed}
- **In Progress:** ${breakdown.by_completion.in_progress}
- **Not Started:** ${breakdown.by_completion.not_started}

## üí° Key Insights
${data.insights.map(insight => `- ${insight.replace(/[^\w\s.,!?-]/g, '')}`).join('\n')}

## üéØ Recommendations
${data.recommendations.map(rec => `- ${rec.replace(/[^\w\s.,!?-]/g, '')}`).join('\n')}

---
*Generated by JIRA Capacity Planning Tool on ${new Date().toLocaleDateString()}*`;
        }

        // Sprint report sharing functions
        function populateSprintShareModal(sprintData) {
            // Update modal title
            document.getElementById('shareReportModalLabel').innerHTML = '<i class="fas fa-share-alt me-2"></i>Share Sprint Report';
            
            // Populate summary
            const shareSummary = document.getElementById('shareSummary');
            const totalSprints = sprintData.report.length;
            const avgCompletion = sprintData.report.reduce((sum, sprint) => 
                sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / totalSprints;
            
            shareSummary.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Board ID:</strong> ${sprintData.board_id}</p>
                        <p><strong>Total Sprints:</strong> ${totalSprints}</p>
                        <p><strong>Report Type:</strong> <span class="badge bg-info">Sprint Analysis</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Average Completion:</strong> ${avgCompletion.toFixed(1)}%</p>
                        <p><strong>Generated:</strong> ${new Date(sprintData.generated_at).toLocaleDateString()}</p>
                        <p><strong>Latest Sprint:</strong> ${sprintData.report[0]?.["Sprint Name"] || 'N/A'}</p>
                    </div>
                </div>
            `;
            
            // Update share format when changed
            updateSprintShareText(sprintData);
        }

        function updateSprintShareText(sprintData) {
            const format = document.getElementById('shareFormat').value;
            const shareText = document.getElementById('shareText');
            
            let content = '';
            
            switch (format) {
                case 'summary':
                    content = generateSprintExecutiveSummary(sprintData);
                    break;
                case 'detailed':
                    content = generateSprintDetailedReport(sprintData);
                    break;
                case 'metrics':
                    content = generateSprintMetricsOnly(sprintData);
                    break;
                case 'markdown':
                    content = generateSprintMarkdownReport(sprintData);
                    break;
            }
            
            shareText.value = content;
        }

        function generateSprintExecutiveSummary(data) {
            const totalSprints = data.report.length;
            const avgCompletion = data.report.reduce((sum, sprint) => 
                sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / totalSprints;
            const latestSprint = data.report[0];
            
            return `üèÉ‚Äç‚ôÇÔ∏è SPRINT REPORT SUMMARY

üìã Board ID: ${data.board_id}
üìÖ Analysis Date: ${new Date(data.generated_at).toLocaleDateString()}
üéØ Sprints Analyzed: ${totalSprints}

üìä KEY METRICS:
‚Ä¢ Average Completion Rate: ${avgCompletion.toFixed(1)}%
‚Ä¢ Latest Sprint: ${latestSprint?.["Sprint Name"] || 'N/A'}
‚Ä¢ Latest Completion: ${latestSprint?.["Completion %"] || 'N/A'}
‚Ä¢ Total Completed Issues: ${data.report.reduce((sum, s) => sum + s["Completed"], 0)}

üèÜ TOP PERFORMING SPRINTS:
${data.report
    .sort((a, b) => parseFloat(b["Completion %"]) - parseFloat(a["Completion %"]))
    .slice(0, 3)
    .map(sprint => `‚Ä¢ ${sprint["Sprint Name"]}: ${sprint["Completion %"]}`)
    .join('\n')}

Generated by JIRA Sprint Analysis Tool`;
        }

        function generateSprintDetailedReport(data) {
            const totalSprints = data.report.length;
            const avgCompletion = data.report.reduce((sum, sprint) => 
                sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / totalSprints;
            
            return `üìã DETAILED SPRINT ANALYSIS REPORT

üéØ SPRINT OVERVIEW:
‚Ä¢ Board ID: ${data.board_id}
‚Ä¢ Total Sprints Analyzed: ${totalSprints}
‚Ä¢ Average Completion Rate: ${avgCompletion.toFixed(1)}%
‚Ä¢ Report Generated: ${new Date(data.generated_at).toLocaleDateString()}

üìä SPRINT-BY-SPRINT BREAKDOWN:
${data.report.map(sprint => 
    `\nüèÉ‚Äç‚ôÇÔ∏è ${sprint["Sprint Name"]}
    ‚Ä¢ Period: ${sprint["Start Date"]} to ${sprint["End Date"]}
    ‚Ä¢ Completion Rate: ${sprint["Completion %"]}
    ‚Ä¢ Completed: ${sprint["Completed"]} issues
    ‚Ä¢ Not Completed: ${sprint["Not Completed"]} issues
    ‚Ä¢ Added During Sprint: ${sprint["Added During Sprint"]}
    ‚Ä¢ Removed During Sprint: ${sprint["Removed During Sprint"]}
    ‚Ä¢ Status: ${sprint["Status"]}
    ‚Ä¢ Insight: ${sprint["Insight"]}`
).join('\n')}

üìà SUMMARY STATISTICS:
‚Ä¢ Total Issues Completed: ${data.report.reduce((sum, s) => sum + s["Completed"], 0)}
‚Ä¢ Total Issues Not Completed: ${data.report.reduce((sum, s) => sum + s["Not Completed"], 0)}
‚Ä¢ Total Scope Changes: ${data.report.reduce((sum, s) => sum + s["Added During Sprint"] + s["Removed During Sprint"], 0)}

Generated by JIRA Sprint Analysis Tool
Report Date: ${new Date().toLocaleDateString()}`;
        }

        function generateSprintMetricsOnly(data) {
            const totalSprints = data.report.length;
            const avgCompletion = data.report.reduce((sum, sprint) => 
                sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / totalSprints;
            
            return `üìä SPRINT METRICS - Board ${data.board_id}

üéØ PERFORMANCE SUMMARY:
‚Ä¢ Total Sprints: ${totalSprints}
‚Ä¢ Average Completion: ${avgCompletion.toFixed(1)}%
‚Ä¢ Analysis Date: ${new Date(data.generated_at).toLocaleDateString()}

‚ö° KEY NUMBERS:
‚Ä¢ Total Completed: ${data.report.reduce((sum, s) => sum + s["Completed"], 0)} issues
‚Ä¢ Total Not Completed: ${data.report.reduce((sum, s) => sum + s["Not Completed"], 0)} issues
‚Ä¢ Scope Changes: ${data.report.reduce((sum, s) => sum + s["Added During Sprint"] + s["Removed During Sprint"], 0)} issues

üèÜ BEST SPRINT: ${data.report.reduce((best, current) => 
    parseFloat(current["Completion %"]) > parseFloat(best["Completion %"]) ? current : best
)["Sprint Name"]} (${data.report.reduce((best, current) => 
    parseFloat(current["Completion %"]) > parseFloat(best["Completion %"]) ? current : best
)["Completion %"]})

Generated: ${new Date().toLocaleDateString()}`;
        }

        function generateSprintMarkdownReport(data) {
            const totalSprints = data.report.length;
            const avgCompletion = data.report.reduce((sum, sprint) => 
                sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / totalSprints;
            
            return `# üèÉ‚Äç‚ôÇÔ∏è Sprint Analysis Report

## üìã Overview
- **Board ID:** ${data.board_id}
- **Total Sprints:** ${totalSprints}
- **Average Completion:** ${avgCompletion.toFixed(1)}%
- **Generated:** ${new Date(data.generated_at).toLocaleDateString()}

## üìä Sprint Performance

| Sprint Name | Completion % | Completed | Not Completed | Added | Removed | Status |
|-------------|--------------|-----------|---------------|-------|---------|--------|
${data.report.map(sprint => 
    `| ${sprint["Sprint Name"]} | ${sprint["Completion %"]} | ${sprint["Completed"]} | ${sprint["Not Completed"]} | ${sprint["Added During Sprint"]} | ${sprint["Removed During Sprint"]} | ${sprint["Status"]} |`
).join('\n')}

## üìà Summary Statistics
- **Total Completed Issues:** ${data.report.reduce((sum, s) => sum + s["Completed"], 0)}
- **Total Not Completed:** ${data.report.reduce((sum, s) => sum + s["Not Completed"], 0)}
- **Total Scope Changes:** ${data.report.reduce((sum, s) => sum + s["Added During Sprint"] + s["Removed During Sprint"], 0)}

## üèÜ Top Performing Sprints
${data.report
    .sort((a, b) => parseFloat(b["Completion %"]) - parseFloat(a["Completion %"]))
    .slice(0, 3)
    .map((sprint, index) => `${index + 1}. **${sprint["Sprint Name"]}** - ${sprint["Completion %"]}`)
    .join('\n')}

---
*Generated by JIRA Sprint Analysis Tool on ${new Date().toLocaleDateString()}*`;
        }

        function generateSprintSlackFormat(data) {
            const totalSprints = data.report.length;
            const avgCompletion = data.report.reduce((sum, sprint) => 
                sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / totalSprints;
            const latestSprint = data.report[0];
            
            return `:runner: *SPRINT ANALYSIS REPORT*

:clipboard: *Board ID:* ${data.board_id}
:calendar: *Analysis Date:* ${new Date(data.generated_at).toLocaleDateString()}
:dart: *Sprints Analyzed:* ${totalSprints}

:chart_with_upwards_trend: *KEY METRICS:*
‚Ä¢ Average Completion Rate: *${avgCompletion.toFixed(1)}%*
‚Ä¢ Latest Sprint: ${latestSprint?.["Sprint Name"] || 'N/A'}
‚Ä¢ Latest Completion: *${latestSprint?.["Completion %"] || 'N/A'}*
‚Ä¢ Total Completed Issues: *${data.report.reduce((sum, s) => sum + s["Completed"], 0)}*

:trophy: *TOP PERFORMING SPRINTS:*
${data.report
    .sort((a, b) => parseFloat(b["Completion %"]) - parseFloat(a["Completion %"]))
    .slice(0, 3)
    .map((sprint, index) => `${index + 1}. ${sprint["Sprint Name"]}: *${sprint["Completion %"]}*`)
    .join('\n')}

_Generated by JIRA Sprint Analysis Tool_`;
        }

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (capacityProgressInterval) {
                clearInterval(capacityProgressInterval);
            }
        });

        // Settings Modal JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings on page load
            loadSettings();
            applyChartSettings();

            // Load JIRA settings when modal opens
            document.getElementById('settingsModal').addEventListener('show.bs.modal', function() {
                loadJiraSettings();
            });

            // Toggle API token visibility
            document.getElementById('toggleApiToken').addEventListener('click', function() {
                const tokenInput = document.getElementById('jiraApiToken');
                const icon = this.querySelector('i');
                
                if (tokenInput.type === 'password') {
                    tokenInput.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    tokenInput.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            });

            // Test JIRA connection
            document.getElementById('testJiraConnection').addEventListener('click', async function() {
                const button = this;
                const originalText = button.innerHTML;
                const statusDiv = document.getElementById('connectionStatus');
                const userInfoDiv = document.getElementById('jiraUserInfo');
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
                button.disabled = true;

                try {
                    const response = await fetch('/api/settings/test-jira', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: document.getElementById('jiraUrl').value,
                            email: document.getElementById('jiraEmail').value,
                            token: document.getElementById('jiraApiToken').value
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.innerHTML = '<div class="text-success"><i class="fas fa-check-circle me-2"></i>Connection successful</div>';
                        if (result.user_info) {
                            document.getElementById('userDetails').innerHTML = `
                                <strong>${result.user_info.displayName}</strong><br>
                                <small class="text-muted">${result.user_info.emailAddress}</small>
                            `;
                            userInfoDiv.style.display = 'block';
                        }
                    } else {
                        statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-times-circle me-2"></i>Connection failed: ${result.error}</div>`;
                        userInfoDiv.style.display = 'none';
                    }
                } catch (error) {
                    statusDiv.innerHTML = '<div class="text-danger"><i class="fas fa-times-circle me-2"></i>Connection error</div>';
                    userInfoDiv.style.display = 'none';
                }

                button.innerHTML = originalText;
                button.disabled = false;
            });

            // Save JIRA configuration
            document.getElementById('saveJiraConfig').addEventListener('click', async function() {
                const config = {
                    url: document.getElementById('jiraUrl').value,
                    email: document.getElementById('jiraEmail').value,
                    token: document.getElementById('jiraApiToken').value
                };

                try {
                    const response = await fetch('/api/settings/save-jira', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        showToast('JIRA configuration saved successfully', 'success');
                    } else {
                        showToast('Failed to save JIRA configuration', 'error');
                    }
                } catch (error) {
                    showToast('Error saving JIRA configuration', 'error');
                }
            });

            // Save all settings
            document.getElementById('saveAllSettings').addEventListener('click', function() {
                saveAllSettings();
            });

            // Sprint Search Functionality
            const sprintSearchInput = document.getElementById('sprintSearchInput');
            const clearSprintSearchBtn = document.getElementById('clearSprintSearchBtn');

            // Search input event listener
            sprintSearchInput.addEventListener('input', function() {
                const searchTerm = this.value;
                filterSprintReport(searchTerm);
            });

            // Clear search button event listener
            clearSprintSearchBtn.addEventListener('click', function() {
                sprintSearchInput.value = '';
                filterSprintReport('');
            });

            // Enter key to clear search
            sprintSearchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    filterSprintReport('');
                }
            });

            // Theme change handler
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    applyTheme(this.value);
                });
            });

            // Default view change handler
            document.getElementById('defaultView').addEventListener('change', function() {
                localStorage.setItem('defaultView', this.value);
            });

            // Apply default view on page load
            const defaultView = localStorage.getItem('defaultView');
            if (defaultView) {
                // Find the corresponding navigation link and trigger click
                const navLinks = document.querySelectorAll('.sidebar .nav-link');
                navLinks.forEach(link => {
                    const text = link.textContent.trim().toLowerCase().replace(/\s+/g, '-');
                    if (text === defaultView) {
                        link.click();
                    }
                });
            }

            // Share modal event listeners
            document.getElementById('shareFormat').addEventListener('change', function() {
                if (currentReportData) {
                    updateShareText(currentReportData);
                } else if (currentSprintReportData) {
                    updateSprintShareText(currentSprintReportData);
                }
            });

            // Copy to clipboard
            document.getElementById('copyToClipboard').addEventListener('click', async function() {
                const shareText = document.getElementById('shareText');
                try {
                    await navigator.clipboard.writeText(shareText.value);
                    showToast('Report copied to clipboard!', 'success');
                } catch (err) {
                    // Fallback for older browsers
                    shareText.select();
                    document.execCommand('copy');
                    showToast('Report copied to clipboard!', 'success');
                }
            });

            // Generate share link
            document.getElementById('generateShareLink').addEventListener('click', async function() {
                if (!currentReportData) return;
                
                const button = this;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
                button.disabled = true;

                try {
                    const response = await fetch('/api/capacity/share-link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            report_data: currentReportData,
                            expires_in_days: 7
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        document.getElementById('shareLink').value = result.share_url;
                        document.getElementById('shareLinkCard').style.display = 'block';
                        showToast('Share link generated successfully!', 'success');
                    } else {
                        showToast('Failed to generate share link', 'error');
                    }
                } catch (error) {
                    showToast('Error generating share link', 'error');
                }

                button.innerHTML = originalText;
                button.disabled = false;
            });

            // Copy share link
            document.getElementById('copyShareLink').addEventListener('click', async function() {
                const shareLink = document.getElementById('shareLink');
                try {
                    await navigator.clipboard.writeText(shareLink.value);
                    showToast('Share link copied to clipboard!', 'success');
                } catch (err) {
                    shareLink.select();
                    document.execCommand('copy');
                    showToast('Share link copied to clipboard!', 'success');
                }
            });

            // Screenshot functionality
            let capturedScreenshot = null;

            document.getElementById('captureScreenshot').addEventListener('click', async function() {
                const button = this;
                const originalHTML = button.innerHTML;
                
                try {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Capturing...';
                    button.disabled = true;
                    
                    // Get the appropriate results section
                    let resultsSection;
                    if (currentReportData) {
                        resultsSection = document.getElementById('capacityAnalysisResults');
                    } else if (currentSprintReportData) {
                        resultsSection = document.getElementById('sprintReportSection');
                    }
                    
                    if (!resultsSection || resultsSection.style.display === 'none') {
                        showToast('No report visible to capture', 'error');
                        return;
                    }
                    
                    // Configure html2canvas options
                    const options = {
                        backgroundColor: '#ffffff',
                        scale: 2, // Higher quality
                        useCORS: true,
                        allowTaint: false,
                        scrollX: 0,
                        scrollY: 0,
                        width: resultsSection.scrollWidth,
                        height: resultsSection.scrollHeight,
                        onclone: function(clonedDoc) {
                            // Ensure charts are rendered in the clone
                            const charts = clonedDoc.querySelectorAll('canvas');
                            charts.forEach(chart => {
                                chart.style.backgroundColor = 'white';
                            });
                        }
                    };
                    
                    // Capture the screenshot
                    const canvas = await html2canvas(resultsSection, options);
                    
                    // Convert to blob
                    canvas.toBlob(function(blob) {
                        capturedScreenshot = {
                            blob: blob,
                            dataUrl: canvas.toDataURL('image/png')
                        };
                        
                        // Show preview
                        document.getElementById('screenshotPreview').src = capturedScreenshot.dataUrl;
                        document.getElementById('screenshotPreviewCard').style.display = 'block';
                        
                        // Enable screenshot sharing buttons
                        document.getElementById('shareScreenshotWhatsApp').disabled = false;
                        document.getElementById('shareScreenshotSlack').disabled = false;
                        document.getElementById('shareScreenshotEmail').disabled = false;
                        document.getElementById('downloadScreenshot').disabled = false;
                        document.getElementById('createVisualShareLink').disabled = false;
                        
                        showToast('Screenshot captured successfully!', 'success');
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Screenshot capture failed:', error);
                    showToast('Failed to capture screenshot', 'error');
                } finally {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            });

            // Download screenshot
            document.getElementById('downloadScreenshot').addEventListener('click', function() {
                if (!capturedScreenshot) return;
                
                const link = document.createElement('a');
                let filename;
                if (currentReportData) {
                    filename = `capacity-analysis-${currentReportData.user_email.split('@')[0]}-${new Date().toISOString().split('T')[0]}.png`;
                } else if (currentSprintReportData) {
                    filename = `sprint-analysis-board-${currentSprintReportData.board_id}-${new Date().toISOString().split('T')[0]}.png`;
                } else {
                    filename = `jira-report-${new Date().toISOString().split('T')[0]}.png`;
                }
                
                link.download = filename;
                link.href = capturedScreenshot.dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Screenshot downloaded!', 'success');
            });

            // Share screenshot to WhatsApp
            document.getElementById('shareScreenshotWhatsApp').addEventListener('click', function() {
                if (!capturedScreenshot) return;
                
                let summary;
                if (currentReportData) {
                    summary = `üìä Capacity Analysis Report\n\nüë§ ${currentReportData.user_email}\n‚≠ê Rating: ${currentReportData.overall_rating}\nüìà Completion Rate: ${(currentReportData.metrics.completion_rate * 100).toFixed(1)}%\n\nDetailed visual report attached! üì∏`;
                } else if (currentSprintReportData) {
                    const avgCompletion = currentSprintReportData.report.reduce((sum, sprint) => 
                        sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / currentSprintReportData.report.length;
                    summary = `üèÉ‚Äç‚ôÇÔ∏è Sprint Analysis Report\n\nüìã Board: ${currentSprintReportData.board_id}\nüéØ Sprints: ${currentSprintReportData.report.length}\nüìà Avg Completion: ${avgCompletion.toFixed(1)}%\n\nDetailed visual report attached! üì∏`;
                } else {
                    return;
                }
                
                // For WhatsApp Web, we can't directly share images, so we'll copy the text and show instructions
                navigator.clipboard.writeText(summary).then(() => {
                    showToast('Summary copied! Download the screenshot and share both to WhatsApp.', 'info');
                    // Auto-trigger download
                    document.getElementById('downloadScreenshot').click();
                });
            });

            // Share screenshot to Slack
            document.getElementById('shareScreenshotSlack').addEventListener('click', function() {
                if (!capturedScreenshot) return;
                
                let summary;
                if (currentReportData) {
                    summary = `üìä *Capacity Analysis Report*\n\nüë§ *User:* ${currentReportData.user_email}\n‚≠ê *Rating:* ${currentReportData.overall_rating}\nüìà *Completion Rate:* ${(currentReportData.metrics.completion_rate * 100).toFixed(1)}%\n\nDetailed visual report attached! üì∏`;
                } else if (currentSprintReportData) {
                    const avgCompletion = currentSprintReportData.report.reduce((sum, sprint) => 
                        sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / currentSprintReportData.report.length;
                    summary = `üèÉ‚Äç‚ôÇÔ∏è *Sprint Analysis Report*\n\nüìã *Board:* ${currentSprintReportData.board_id}\nüéØ *Sprints:* ${currentSprintReportData.report.length}\nüìà *Avg Completion:* ${avgCompletion.toFixed(1)}%\n\nDetailed visual report attached! üì∏`;
                } else {
                    return;
                }
                
                navigator.clipboard.writeText(summary).then(() => {
                    showToast('Summary copied! Download the screenshot and share both to Slack.', 'info');
                    // Auto-trigger download
                    document.getElementById('downloadScreenshot').click();
                });
            });

            // Email with screenshot
            document.getElementById('shareScreenshotEmail').addEventListener('click', function() {
                if (!capturedScreenshot) return;
                
                let subject, body;
                if (currentReportData) {
                    subject = `Capacity Analysis Report - ${currentReportData.user_email} (Visual Report)`;
                    body = `Hi,\n\nPlease find attached the capacity analysis report for ${currentReportData.user_email}.\n\nKey Highlights:\n‚Ä¢ Overall Rating: ${currentReportData.overall_rating}\n‚Ä¢ Completion Rate: ${(currentReportData.metrics.completion_rate * 100).toFixed(1)}%\n‚Ä¢ Avg Completed/Week: ${currentReportData.metrics.avg_completed_per_week.toFixed(1)}\n‚Ä¢ Total Issues Analyzed: ${currentReportData.total_issues_analyzed}\n\nThe visual report screenshot will be downloaded automatically. Please attach it to your email.\n\nBest regards`;
                } else if (currentSprintReportData) {
                    const avgCompletion = currentSprintReportData.report.reduce((sum, sprint) => 
                        sum + parseFloat(sprint["Completion %"].replace('%', '')), 0) / currentSprintReportData.report.length;
                    subject = `Sprint Analysis Report - Board ${currentSprintReportData.board_id} (Visual Report)`;
                    body = `Hi,\n\nPlease find attached the sprint analysis report for Board ${currentSprintReportData.board_id}.\n\nKey Highlights:\n‚Ä¢ Total Sprints Analyzed: ${currentSprintReportData.report.length}\n‚Ä¢ Average Completion Rate: ${avgCompletion.toFixed(1)}%\n‚Ä¢ Total Completed Issues: ${currentSprintReportData.report.reduce((sum, s) => sum + s["Completed"], 0)}\n‚Ä¢ Total Issues Not Completed: ${currentSprintReportData.report.reduce((sum, s) => sum + s["Not Completed"], 0)}\n\nThe visual report screenshot will be downloaded automatically. Please attach it to your email.\n\nBest regards`;
                } else {
                    return;
                }
                
                // Auto-trigger download and open email
                document.getElementById('downloadScreenshot').click();
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;
            });

            // Create visual share link
            document.getElementById('createVisualShareLink').addEventListener('click', async function() {
                if (!capturedScreenshot) return;
                
                const reportData = currentReportData || currentSprintReportData;
                if (!reportData) return;
                
                const button = this;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
                button.disabled = true;

                try {
                    // Convert blob to file
                    const file = new File([capturedScreenshot.blob], 'capacity-report.png', { type: 'image/png' });
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('screenshot', file);
                    formData.append('report_data', JSON.stringify(reportData));

                    // Upload screenshot
                    const uploadResponse = await fetch('/api/capacity/upload-screenshot', {
                        method: 'POST',
                        body: formData
                    });

                    if (uploadResponse.ok) {
                        const uploadResult = await uploadResponse.json();
                        
                        // Create share link with screenshot
                        const shareResponse = await fetch('/api/capacity/share-link', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                report_data: reportData,
                                screenshot_url: uploadResult.screenshot_url,
                                expires_in_days: 7
                            })
                        });

                        if (shareResponse.ok) {
                            const shareResult = await shareResponse.json();
                            document.getElementById('shareLink').value = shareResult.share_url;
                            document.getElementById('shareLinkCard').style.display = 'block';
                            showToast('Visual share link created with screenshot!', 'success');
                        } else {
                            showToast('Failed to create share link', 'error');
                        }
                    } else {
                        showToast('Failed to upload screenshot', 'error');
                    }
                } catch (error) {
                    console.error('Error creating visual share link:', error);
                    showToast('Error creating visual share link', 'error');
                }

                button.innerHTML = originalText;
                button.disabled = false;
            });

            // Platform-specific sharing
            document.getElementById('shareToTeams').addEventListener('click', function() {
                let text, topicName;
                if (currentReportData) {
                    text = generateExecutiveSummary(currentReportData);
                    topicName = 'Capacity%20Analysis%20Report';
                } else if (currentSprintReportData) {
                    text = generateSprintExecutiveSummary(currentSprintReportData);
                    topicName = 'Sprint%20Analysis%20Report';
                } else {
                    return;
                }
                const teamsUrl = `https://teams.microsoft.com/l/chat/0/0?users=&topicName=${topicName}&message=${encodeURIComponent(text)}`;
                window.open(teamsUrl, '_blank');
            });

            document.getElementById('shareToWhatsApp').addEventListener('click', function() {
                let text;
                if (currentReportData) {
                    text = generateExecutiveSummary(currentReportData);
                } else if (currentSprintReportData) {
                    text = generateSprintExecutiveSummary(currentSprintReportData);
                } else {
                    return;
                }
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(whatsappUrl, '_blank');
            });

            document.getElementById('shareToSlack').addEventListener('click', function() {
                let text;
                if (currentReportData) {
                    text = generateSlackFormat(currentReportData);
                } else if (currentSprintReportData) {
                    text = generateSprintSlackFormat(currentSprintReportData);
                } else {
                    return;
                }
                // For Slack, we'll copy to clipboard since direct integration requires app setup
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Report copied! Paste it in your Slack channel.', 'info');
                });
            });

            document.getElementById('shareToEmail').addEventListener('click', function() {
                let subject, body;
                if (currentReportData) {
                    subject = `Capacity Analysis Report - ${currentReportData.user_email}`;
                    body = generateDetailedReport(currentReportData);
                } else if (currentSprintReportData) {
                    subject = `Sprint Analysis Report - Board ${currentSprintReportData.board_id}`;
                    body = generateSprintDetailedReport(currentSprintReportData);
                } else {
                    return;
                }
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;
            });

            document.getElementById('shareToLinkedIn').addEventListener('click', function() {
                let text;
                if (currentReportData) {
                    text = `Just completed a capacity analysis! üìä\n\n${generateMetricsOnly(currentReportData)}`;
                } else if (currentSprintReportData) {
                    text = `Just completed a sprint analysis! üèÉ‚Äç‚ôÇÔ∏è\n\n${generateSprintMetricsOnly(currentSprintReportData)}`;
                } else {
                    return;
                }
                const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}&summary=${encodeURIComponent(text)}`;
                window.open(linkedinUrl, '_blank');
            });
        });

        async function loadJiraSettings() {
            try {
                const response = await fetch('/api/settings/load-jira');
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('jiraUrl').value = settings.url || '';
                    document.getElementById('jiraEmail').value = settings.email || '';
                    
                    const tokenInput = document.getElementById('jiraApiToken');
                    const tokenStatus = document.getElementById('tokenStatus');
                    const editButton = document.getElementById('editApiToken');
                    const maskedTokenText = document.getElementById('maskedTokenText');
                    
                    // Show token status without revealing the actual token
                    if (settings.has_token) {
                        // Hide the input and show status
                        tokenInput.style.display = 'none';
                        tokenInput.value = ''; // Clear any previous value
                        document.getElementById('toggleApiToken').style.display = 'none';
                        tokenStatus.style.display = 'block';
                        editButton.style.display = 'block';
                        
                        // Set masked token
                        if (settings.masked_token) {
                            maskedTokenText.textContent = settings.masked_token;
                        }
                        
                        // Show creation/update info if available
                        if (settings.updated_at) {
                            const updateDate = new Date(settings.updated_at).toLocaleDateString();
                            const statusText = document.querySelector('#tokenStatus small');
                            statusText.innerHTML += ` (Updated: ${updateDate})`;
                        }
                    } else {
                        // Show input for new token
                        tokenInput.style.display = 'block';
                        tokenInput.placeholder = 'Enter your JIRA API token';
                        document.getElementById('toggleApiToken').style.display = 'block';
                        tokenStatus.style.display = 'none';
                        editButton.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading JIRA settings:', error);
            }
        }

        // Event handlers for token management
        document.addEventListener('DOMContentLoaded', function() {
            // Show/hide masked token
            document.getElementById('showMaskedToken').addEventListener('click', function() {
                const display = document.getElementById('maskedTokenDisplay');
                if (display.style.display === 'none') {
                    display.style.display = 'block';
                    this.textContent = 'Hide masked token';
                } else {
                    display.style.display = 'none';
                    this.textContent = 'Show masked token';
                }
            });

            // Edit token button
            document.getElementById('editApiToken').addEventListener('click', function() {
                const tokenInput = document.getElementById('jiraApiToken');
                const tokenStatus = document.getElementById('tokenStatus');
                const editButton = document.getElementById('editApiToken');
                
                // Show input for editing
                tokenInput.style.display = 'block';
                tokenInput.placeholder = 'Enter new API token';
                tokenInput.focus();
                document.getElementById('toggleApiToken').style.display = 'block';
                
                // Hide status temporarily
                tokenStatus.style.display = 'none';
                editButton.style.display = 'none';
            });

            // Reset form when modal is closed
            document.getElementById('settingsModal').addEventListener('hidden.bs.modal', function() {
                // Reload settings to reset any unsaved changes
                loadJiraSettings();
            });
        });

        function loadSettings() {
            // JIRA settings are loaded separately when modal opens

            // Load export settings
            const exportSettings = JSON.parse(localStorage.getItem('exportSettings') || '{}');
            if (exportSettings.delimiter) document.getElementById('csvDelimiter').value = exportSettings.delimiter;
            if (exportSettings.encoding) document.getElementById('csvEncoding').value = exportSettings.encoding;
            if (exportSettings.includeHeaders !== undefined) document.getElementById('includeHeaders').checked = exportSettings.includeHeaders;
            if (exportSettings.autoExportEnabled !== undefined) document.getElementById('autoExportEnabled').checked = exportSettings.autoExportEnabled;
            if (exportSettings.frequency) document.getElementById('autoExportFrequency').value = exportSettings.frequency;
            if (exportSettings.email) document.getElementById('autoExportEmail').value = exportSettings.email;

            // Load UI settings
            const uiSettings = JSON.parse(localStorage.getItem('uiSettings') || '{}');
            if (uiSettings.theme) {
                document.querySelector(`input[name="theme"][value="${uiSettings.theme}"]`).checked = true;
                applyTheme(uiSettings.theme);
            }
            if (uiSettings.defaultView) document.getElementById('defaultView').value = uiSettings.defaultView;
            if (uiSettings.cardsPerRow) document.getElementById('cardsPerRow').value = uiSettings.cardsPerRow;
            if (uiSettings.compactMode !== undefined) document.getElementById('compactMode').checked = uiSettings.compactMode;
            if (uiSettings.chartType) document.getElementById('chartType').value = uiSettings.chartType;
            if (uiSettings.chartColors) document.getElementById('chartColors').value = uiSettings.chartColors;
            if (uiSettings.animatedCharts !== undefined) document.getElementById('animatedCharts').checked = uiSettings.animatedCharts;
        }

        function saveAllSettings() {
            // Save export settings
            const exportSettings = {
                delimiter: document.getElementById('csvDelimiter').value,
                encoding: document.getElementById('csvEncoding').value,
                includeHeaders: document.getElementById('includeHeaders').checked,
                autoExportEnabled: document.getElementById('autoExportEnabled').checked,
                frequency: document.getElementById('autoExportFrequency').value,
                email: document.getElementById('autoExportEmail').value
            };
            localStorage.setItem('exportSettings', JSON.stringify(exportSettings));

            // Save UI settings
            const uiSettings = {
                theme: document.querySelector('input[name="theme"]:checked').value,
                defaultView: document.getElementById('defaultView').value,
                cardsPerRow: document.getElementById('cardsPerRow').value,
                compactMode: document.getElementById('compactMode').checked,
                chartType: document.getElementById('chartType').value,
                chartColors: document.getElementById('chartColors').value,
                animatedCharts: document.getElementById('animatedCharts').checked
            };
            localStorage.setItem('uiSettings', JSON.stringify(uiSettings));

            // Apply settings immediately
            applyChartSettings();

            showToast('Settings saved successfully', 'success');
        }

        function applyTheme(theme) {
            const body = document.body;
            
            // Remove existing theme classes
            body.classList.remove('theme-light', 'theme-dark');
            
            if (theme === 'dark') {
                body.classList.add('theme-dark');
            } else if (theme === 'light') {
                body.classList.add('theme-light');
            } else if (theme === 'auto') {
                // Use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.add('theme-dark');
                } else {
                    body.classList.add('theme-light');
                }
            }
        }

        function getChartColors(scheme = 'default') {
            const colorSchemes = {
                default: ['#00ABE4', '#E9F1FA', '#0088b8', '#d1e5f5', '#006fa3'],
                colorful: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'],
                monochrome: ['#2c3e50', '#34495e', '#7f8c8d', '#95a5a6', '#bdc3c7'],
                pastel: ['#ffeaa7', '#fab1a0', '#fd79a8', '#e17055', '#a29bfe']
            };
            return colorSchemes[scheme] || colorSchemes.default;
        }

        function applyChartSettings() {
            const uiSettings = JSON.parse(localStorage.getItem('uiSettings') || '{}');
            const chartColors = uiSettings.chartColors || 'default';
            const animatedCharts = uiSettings.animatedCharts !== false; // default true
            
            // Store globally for use in chart creation
            window.chartSettings = {
                colors: getChartColors(chartColors),
                animated: animatedCharts
            };
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Help Section Functionality
        function loadHelpContent(role) {
            const helpContent = document.getElementById('helpContent');
            const content = getHelpContentByRole(role);
            helpContent.innerHTML = content;
        }

        function getHelpContentByRole(role) {
            const helpData = {
                all: {
                    title: "General Jira Best Practices",
                    practices: [
                        {
                            title: "Advanced JQL Queries & Filters",
                            description: "Powerful JQL queries that most teams don't know about but can save hours of manual work.",
                            tips: [
                                "Find issues updated in last business days: 'updated >= -5d AND updated <= -1d AND dayOfWeek(updated) not in (1,7)'",
                                "Identify stale issues: 'status changed before -30d AND status not in (Done, Closed)'",
                                "Find overdue issues: 'due < now() AND status not in (Done, Closed, Cancelled)'",
                                "Track cross-project dependencies: 'issueFunction in linkedIssuesOf(\"project = PROJ1\")'",
                                "Find issues without estimates: 'originalEstimate is EMPTY AND status not in (Done, Closed)'",
                                "Identify potential scope creep: 'created >= startOfWeek() AND Sprint in openSprints()'",
                                "Find issues with excessive comments: 'comment ~ \"*\" AND numberOfComments > 10'"
                            ],
                            resources: [
                                { title: "JQL Functions Reference", url: "https://support.atlassian.com/jira-software-cloud/docs/advanced-search-reference-jql-functions/" },
                                { title: "JQL Cookbook", url: "https://community.atlassian.com/t5/Jira-Software-questions/JQL-Cookbook/qaq-p/1013942" }
                            ]
                        },
                        {
                            title: "Hidden Jira Productivity Hacks",
                            description: "Lesser-known features and shortcuts that can dramatically improve your Jira efficiency.",
                            tips: [
                                "Use 'g + i' keyboard shortcut to quickly create issues from anywhere",
                                "Bulk edit issues using JQL: Select multiple issues and use 'Tools > Bulk Change'",
                                "Create issue templates using Description Templates add-on or custom fields",
                                "Use issue cloning with 'More > Clone' to replicate complex issue structures",
                                "Set up email handlers to create issues from emails automatically",
                                "Use sub-tasks for breaking down work without losing parent context",
                                "Create personal dashboards with gadgets for your specific workflow",
                                "Use '@mentions' in comments to notify specific team members"
                            ],
                            resources: [
                                { title: "Jira Keyboard Shortcuts", url: "https://support.atlassian.com/jira-software-cloud/docs/use-keyboard-shortcuts/" },
                                { title: "Automation Rules", url: "https://support.atlassian.com/cloud-automation/docs/jira-cloud-automation/" }
                            ]
                        },
                        {
                            title: "Team Performance Metrics & KPIs",
                            description: "Key metrics to track team health and productivity that aren't obvious in standard reports.",
                            tips: [
                                "Cycle Time: Track average time from 'In Progress' to 'Done' status",
                                "Lead Time: Measure from issue creation to completion",
                                "Throughput: Count of issues completed per sprint/week",
                                "Work Item Age: How long issues stay in each status",
                                "Blocked Time: Track time issues spend in 'Blocked' status",
                                "Rework Rate: Percentage of issues that return to previous states",
                                "Scope Change Rate: Issues added/removed during sprints",
                                "Defect Escape Rate: Bugs found in production vs. caught in testing"
                            ],
                            resources: [
                                { title: "Agile Metrics Guide", url: "https://www.atlassian.com/agile/project-management/metrics" },
                                { title: "Control Chart Plugin", url: "https://marketplace.atlassian.com/search?query=control%20chart" }
                            ]
                        },
                        {
                            title: "Project Organization",
                            description: "Keep projects well-organized with clear naming conventions and consistent structure.",
                            tips: [
                                "Use descriptive project names and keys",
                                "Establish consistent issue naming patterns",
                                "Create clear project descriptions and documentation"
                            ],
                            resources: [
                                { title: "Project Management Best Practices", url: "https://support.atlassian.com/jira-software-cloud/docs/what-is-a-jira-software-project/" },
                                { title: "Organizing Work in Jira", url: "https://www.atlassian.com/software/jira/guides/getting-started/basics#step-2-create-an-issue" }
                            ]
                        },
                        {
                            title: "Issue Management",
                            description: "Create clear, actionable issues with proper categorization and priority setting.",
                            tips: [
                                "Write clear, concise issue summaries",
                                "Use appropriate issue types (Story, Bug, Task, Epic)",
                                "Set realistic priorities and due dates",
                                "Add relevant labels and components"
                            ],
                            resources: [
                                { title: "Creating Issues", url: "https://support.atlassian.com/jira-software-cloud/docs/create-an-issue-and-a-sub-task/" },
                                { title: "Issue Types Guide", url: "https://support.atlassian.com/jira-software-cloud/docs/what-are-issue-types/" }
                            ]
                        },
                        {
                            title: "Writing Effective User Stories",
                            description: "Create user stories that clearly communicate value and requirements to the development team.",
                            tips: [
                                "Use the standard format: 'As a [user type], I want [functionality] so that [benefit]'",
                                "Keep stories focused on a single piece of functionality",
                                "Write from the user's perspective, not technical implementation",
                                "Include clear acceptance criteria using Given-When-Then format",
                                "Ensure stories are testable and demonstrable",
                                "Break down large stories (epics) into smaller, manageable pieces",
                                "Add story points for estimation and planning"
                            ],
                            resources: [
                                { title: "User Story Guide", url: "https://www.atlassian.com/agile/project-management/user-stories" },
                                { title: "Writing Acceptance Criteria", url: "https://www.atlassian.com/agile/project-management/user-stories#acceptance-criteria" },
                                { title: "Story Splitting Techniques", url: "https://www.atlassian.com/agile/project-management/epics-stories-themes" }
                            ]
                        },
                        {
                            title: "Story Estimation Best Practices",
                            description: "Effectively estimate story complexity and effort using proven techniques.",
                            tips: [
                                "Use relative sizing (story points) rather than time estimates",
                                "Employ Planning Poker or similar consensus-building techniques",
                                "Consider complexity, effort, and uncertainty in estimates",
                                "Use Fibonacci sequence (1, 2, 3, 5, 8, 13) for story points",
                                "Establish team baseline with reference stories",
                                "Re-estimate when new information becomes available",
                                "Track velocity to improve future estimations",
                                "Break down stories larger than 8 points"
                            ],
                            resources: [
                                { title: "Story Point Estimation", url: "https://www.atlassian.com/agile/project-management/estimation" },
                                { title: "Planning Poker Guide", url: "https://www.atlassian.com/blog/platform/a-brief-overview-of-planning-poker" },
                                { title: "Velocity Tracking", url: "https://support.atlassian.com/jira-software-cloud/docs/view-and-understand-the-velocity-chart/" }
                            ]
                        },
                        {
                            title: "Time Logging & Tracking",
                            description: "Accurately track time spent on work items for better project visibility and future planning.",
                            tips: [
                                "Log time daily to ensure accuracy and completeness",
                                "Break down time by activity type (development, testing, review, etc.)",
                                "Use consistent time format (hours or days) across the team",
                                "Include both original estimate and time spent",
                                "Update remaining estimate as work progresses",
                                "Add work log comments to explain time spent",
                                "Use time tracking for retrospective analysis",
                                "Set up automated reminders for time logging"
                            ],
                            resources: [
                                { title: "Time Tracking in Jira", url: "https://support.atlassian.com/jira-software-cloud/docs/log-time-on-an-issue/" },
                                { title: "Worklog Management", url: "https://support.atlassian.com/jira-software-cloud/docs/view-time-tracking-information/" },
                                { title: "Time Tracking Reports", url: "https://support.atlassian.com/jira-software-cloud/docs/view-time-tracking-reports/" }
                            ]
                        }
                    ]
                },
                admin: {
                    title: "Jira Administrator Best Practices",
                    practices: [
                        {
                            title: "System Configuration",
                            description: "Properly configure Jira for optimal performance and user experience.",
                            tips: [
                                "Regular system maintenance and updates",
                                "Configure appropriate user permissions and groups",
                                "Set up custom fields and workflows strategically",
                                "Monitor system performance and usage"
                            ],
                            resources: [
                                { title: "Jira Administration Guide", url: "https://support.atlassian.com/jira-software-cloud/docs/jira-software-cloud-administration/" },
                                { title: "User Management", url: "https://support.atlassian.com/atlassian-account/docs/manage-users-in-your-organization/" },
                                { title: "Performance Monitoring", url: "https://support.atlassian.com/jira-software-cloud/docs/monitor-jira-software-performance/" }
                            ]
                        },
                        {
                            title: "Workflow Management",
                            description: "Design efficient workflows that match your team's processes.",
                            tips: [
                                "Keep workflows simple and intuitive",
                                "Use post functions and validators appropriately",
                                "Regular workflow audits and optimization",
                                "Document workflow changes"
                            ],
                            resources: [
                                { title: "Workflow Configuration", url: "https://support.atlassian.com/jira-software-cloud/docs/configure-workflows/" },
                                { title: "Advanced Workflow Features", url: "https://support.atlassian.com/jira-software-cloud/docs/advanced-workflow-configuration/" }
                            ]
                        },
                        {
                            title: "Jira Automation Recipes",
                            description: "Ready-to-use automation rules that solve common administrative pain points.",
                            tips: [
                                "Auto-assign issues based on component: 'When Issue Created > If Component = Frontend > Assign to Frontend Lead'",
                                "Auto-close sub-tasks when parent is done: 'When Issue Transitioned to Done > If has Sub-tasks > Transition all Sub-tasks to Done'",
                                "Notify on stale issues: 'Scheduled trigger (weekly) > If Status unchanged for 14 days > Comment and @mention assignee'",
                                "Auto-update sprint field: 'When Issue added to Sprint > Set custom field Sprint Name = {{ '{{' }}sprint.name{{ '}}' }}'",
                                "Flag high-priority bugs: 'When Bug created with Priority = Highest > Add label \"critical\" and assign to Team Lead'",
                                "Auto-link related issues: 'When Issue created > If Summary contains ticket ID > Link to that issue'",
                                "Send weekly team digest: 'Scheduled trigger (Monday 9AM) > Send email with JQL results to team'",
                                "Auto-transition on PR merge: 'When Development status changes to Done > Transition issue to Code Review'"
                            ],
                            resources: [
                                { title: "Automation Templates", url: "https://support.atlassian.com/cloud-automation/docs/automation-template-library/" },
                                { title: "Smart Values Reference", url: "https://support.atlassian.com/cloud-automation/docs/smart-values/" }
                            ]
                        },
                        {
                            title: "Data Export & Migration Strategies",
                            description: "Advanced techniques for data extraction and system integration that aren't well documented.",
                            tips: [
                                "Use REST API with pagination for large data exports: '/rest/api/2/search?jql=...&startAt=0&maxResults=100'",
                                "Export custom field data: Include 'expand=names' parameter to get field names",
                                "Bulk export attachments using API: Loop through issues and download each attachment",
                                "Export workflow history: Use '/rest/api/2/issue/{issueKey}/changelog' endpoint",
                                "Create backup scripts with curl commands for regular data exports",
                                "Use CSV import with specific field mappings for data migration",
                                "Export user activity data: Combine audit logs with issue history",
                                "Create data validation scripts to ensure export completeness"
                            ],
                            resources: [
                                { title: "REST API Documentation", url: "https://developer.atlassian.com/cloud/jira/platform/rest/v2/intro/" },
                                { title: "Data Export Tools", url: "https://marketplace.atlassian.com/search?query=export" }
                            ]
                        }
                    ]
                },
                "project-manager": {
                    title: "Project Manager Best Practices",
                    practices: [
                        {
                            title: "Sprint Planning",
                            description: "Effectively plan and manage sprints for optimal team productivity.",
                            tips: [
                                "Set realistic sprint goals and capacity",
                                "Ensure proper story estimation and breakdown",
                                "Maintain clear acceptance criteria",
                                "Regular stakeholder communication"
                            ],
                            resources: [
                                { title: "Sprint Planning Guide", url: "https://www.atlassian.com/agile/scrum/sprint-planning" },
                                { title: "Backlog Management", url: "https://support.atlassian.com/jira-software-cloud/docs/manage-your-backlog/" },
                                { title: "Agile Reporting", url: "https://support.atlassian.com/jira-software-cloud/docs/view-and-understand-the-burndown-chart/" }
                            ]
                        },
                        {
                            title: "Team Coordination",
                            description: "Coordinate team activities and track project progress effectively.",
                            tips: [
                                "Regular team check-ins and updates",
                                "Use dashboards for project visibility",
                                "Track and manage dependencies",
                                "Facilitate retrospectives and improvements"
                            ],
                            resources: [
                                { title: "Project Tracking", url: "https://www.atlassian.com/software/jira/guides/expand-jira/jira-dashboard" },
                                { title: "Team Collaboration", url: "https://www.atlassian.com/team-playbook" }
                            ]
                        },
                        {
                            title: "Estimation & Planning",
                            description: "Lead effective estimation sessions and create realistic project plans.",
                            tips: [
                                "Facilitate Planning Poker sessions for story estimation",
                                "Use historical velocity data for sprint planning",
                                "Account for team capacity and availability",
                                "Break down epics into manageable user stories",
                                "Consider technical debt and refactoring in planning",
                                "Plan for buffer time to handle unexpected issues",
                                "Regularly review and adjust estimates based on new information",
                                "Use relative estimation rather than absolute time estimates"
                            ],
                            resources: [
                                { title: "Agile Estimation Techniques", url: "https://www.atlassian.com/agile/project-management/estimation" },
                                { title: "Sprint Planning Best Practices", url: "https://www.atlassian.com/agile/scrum/sprint-planning" },
                                { title: "Capacity Planning Guide", url: "https://www.atlassian.com/agile/project-management/capacity-planning" }
                            ]
                        }
                    ]
                },
                "scrum-master": {
                    title: "Scrum Master Best Practices",
                    practices: [
                        {
                            title: "Scrum Events Management",
                            description: "Facilitate effective Scrum ceremonies and maintain team rhythm.",
                            tips: [
                                "Prepare and facilitate engaging sprint ceremonies",
                                "Keep meetings focused and time-boxed",
                                "Encourage team participation and collaboration",
                                "Track and improve team velocity"
                            ],
                            resources: [
                                { title: "Scrum Events Guide", url: "https://www.atlassian.com/agile/scrum/ceremonies" },
                                { title: "Sprint Retrospectives", url: "https://www.atlassian.com/team-playbook/plays/retrospective" },
                                { title: "Velocity Tracking", url: "https://support.atlassian.com/jira-software-cloud/docs/view-and-understand-the-velocity-chart/" }
                            ]
                        },
                        {
                            title: "Impediment Management",
                            description: "Identify, track, and resolve blockers that impact team productivity.",
                            tips: [
                                "Maintain visible impediment backlogs",
                                "Prioritize and escalate blockers appropriately",
                                "Work with stakeholders to resolve issues",
                                "Track resolution time and patterns"
                            ],
                            resources: [
                                { title: "Impediment Tracking", url: "https://www.atlassian.com/agile/scrum/scrum-master" },
                                { title: "Team Health Monitoring", url: "https://www.atlassian.com/team-playbook/health-monitor" }
                            ]
                        },
                        {
                            title: "Advanced Sprint Analytics",
                            description: "Deep-dive metrics and analysis techniques not available in standard Jira reports.",
                            tips: [
                                "Calculate Flow Efficiency: (Active Work Time) / (Total Lead Time) * 100",
                                "Track Sprint Predictability: Compare committed vs completed story points over time",
                                "Measure Scope Creep Impact: (Added Stories / Original Stories) * 100 per sprint",
                                "Monitor Team Happiness: Create custom field for team mood tracking",
                                "Analyze Work Distribution: Track work allocation across team members",
                                "Calculate Technical Debt Ratio: (Technical Debt Stories / Total Stories) * 100",
                                "Track Defect Injection Rate: Bugs created per story point delivered",
                                "Measure Collaboration Index: Count of issues with multiple assignees/collaborators"
                            ],
                            resources: [
                                { title: "Flow Metrics Guide", url: "https://www.atlassian.com/agile/kanban/wip-limits" },
                                { title: "Team Health Check", url: "https://www.atlassian.com/team-playbook/health-monitor/team-health-check" }
                            ]
                        },
                        {
                            title: "Retrospective Action Tracking",
                            description: "Systematic approach to track and measure retrospective improvements.",
                            tips: [
                                "Create 'Retrospective Action' issue type with custom fields",
                                "Use labels to categorize actions: process, tools, communication, technical",
                                "Set up automation to remind team of pending actions",
                                "Track action completion rate per retrospective",
                                "Create dashboard showing action trends and success rates",
                                "Link actions to specific metrics to measure impact",
                                "Use voting fields to prioritize actions by team consensus",
                                "Create templates for common improvement categories"
                            ],
                            resources: [
                                { title: "Retrospective Playbook", url: "https://www.atlassian.com/team-playbook/plays/retrospective" },
                                { title: "Continuous Improvement", url: "https://www.atlassian.com/agile/project-management/project-retrospectives" }
                            ]
                        }
                    ]
                },
                developer: {
                    title: "Developer Best Practices",
                    practices: [
                        {
                            title: "Issue Workflow Management",
                            description: "Efficiently manage your work items through the development lifecycle.",
                            tips: [
                                "Update issue status regularly and accurately",
                                "Log time spent on tasks for better estimation",
                                "Link related issues and dependencies",
                                "Add meaningful comments and updates"
                            ],
                            resources: [
                                { title: "Working with Issues", url: "https://support.atlassian.com/jira-software-cloud/docs/transition-issues/" },
                                { title: "Time Tracking", url: "https://support.atlassian.com/jira-software-cloud/docs/log-time-on-an-issue/" },
                                { title: "Issue Linking", url: "https://support.atlassian.com/jira-software-cloud/docs/link-issues/" }
                            ]
                        },
                        {
                            title: "Code Integration",
                            description: "Integrate development tools with Jira for better traceability.",
                            tips: [
                                "Link commits to Jira issues using smart commits",
                                "Use branch naming conventions that reference issues",
                                "Integrate with CI/CD pipelines",
                                "Update issues based on code deployment status"
                            ],
                            resources: [
                                { title: "Git Integration", url: "https://support.atlassian.com/jira-software-cloud/docs/reference-issues-in-your-development-work/" },
                                { title: "Smart Commits", url: "https://support.atlassian.com/bitbucket-cloud/docs/use-smart-commits/" },
                                { title: "Development Panel", url: "https://support.atlassian.com/jira-software-cloud/docs/view-development-information-for-an-issue/" }
                            ]
                        },
                        {
                            title: "Time Logging for Developers",
                            description: "Accurately track development time for better project estimation and planning.",
                            tips: [
                                "Log time daily while tasks are fresh in memory",
                                "Break down time by activity: coding, testing, code review, debugging",
                                "Update original estimates as you learn more about the work",
                                "Include time for research, learning, and problem-solving",
                                "Add meaningful work log descriptions for future reference",
                                "Track time spent on technical debt and refactoring",
                                "Use time data to improve future story point estimations",
                                "Set up IDE plugins or tools for easier time tracking"
                            ],
                            resources: [
                                { title: "Developer Time Tracking", url: "https://support.atlassian.com/jira-software-cloud/docs/log-time-on-an-issue/" },
                                { title: "Worklog Best Practices", url: "https://community.atlassian.com/t5/Jira-Software-questions/Best-practices-for-time-tracking-and-logging-work/qaq-p/842474" },
                                { title: "IDE Integrations", url: "https://www.atlassian.com/software/jira/download/ide-plugins" }
                            ]
                        },
                        {
                            title: "Advanced Git-Jira Integration",
                            description: "Power-user techniques for seamless development workflow integration.",
                            tips: [
                                "Use commit hooks to enforce Jira issue references in commits",
                                "Set up branch naming automation: feature/PROJ-123-description",
                                "Create custom smart commit commands: #deploy-staging, #request-review",
                                "Use Git aliases for common Jira operations: git jira-start, git jira-done",
                                "Set up automated PR creation with Jira issue linking",
                                "Configure build status integration to update Jira automatically",
                                "Use webhooks to trigger actions on code deployment",
                                "Create custom fields to track code metrics (lines changed, complexity)"
                            ],
                            resources: [
                                { title: "Git Integration Setup", url: "https://support.atlassian.com/jira-software-cloud/docs/integrate-with-development-tools/" },
                                { title: "Smart Commits Advanced", url: "https://confluence.atlassian.com/fisheye/using-smart-commits-960155400.html" }
                            ]
                        },
                        {
                            title: "Technical Debt Management",
                            description: "Systematic approach to tracking and managing technical debt in Jira.",
                            tips: [
                                "Create 'Technical Debt' issue type with priority and effort fields",
                                "Use labels to categorize debt: security, performance, maintainability, scalability",
                                "Track debt ratio: (Technical Debt Points / Total Story Points) per sprint",
                                "Create automated reports showing debt accumulation trends",
                                "Link debt items to affected user stories for impact analysis",
                                "Set up debt review meetings using Jira filters and dashboards",
                                "Use custom fields to track debt age and business impact",
                                "Create debt payment sprints with dedicated capacity allocation"
                            ],
                            resources: [
                                { title: "Managing Technical Debt", url: "https://www.atlassian.com/agile/software-development/technical-debt" },
                                { title: "Code Quality Metrics", url: "https://www.atlassian.com/continuous-delivery/software-testing/code-coverage" }
                            ]
                        }
                    ]
                },
                tester: {
                    title: "QA/Tester Best Practices",
                    practices: [
                        {
                            title: "Test Case Management",
                            description: "Organize and execute test cases effectively using Jira.",
                            tips: [
                                "Create detailed test cases with clear steps",
                                "Link test cases to user stories and requirements",
                                "Use test execution tracking and reporting",
                                "Maintain test case libraries and reusability"
                            ],
                            resources: [
                                { title: "Test Management in Jira", url: "https://marketplace.atlassian.com/apps/6820/zephyr-for-jira-test-management" },
                                { title: "Testing Best Practices", url: "https://www.atlassian.com/continuous-delivery/software-testing" }
                            ]
                        },
                        {
                            title: "Bug Tracking & Reporting",
                            description: "Effectively report and track defects through resolution.",
                            tips: [
                                "Provide clear bug reproduction steps",
                                "Include relevant screenshots and logs",
                                "Set appropriate severity and priority levels",
                                "Track bug resolution and verification"
                            ],
                            resources: [
                                { title: "Bug Reporting Guide", url: "https://support.atlassian.com/jira-software-cloud/docs/what-is-an-issue/" },
                                { title: "Quality Metrics", url: "https://www.atlassian.com/agile/project-management/metrics" }
                            ]
                        },
                        {
                            title: "Writing Effective Bug Reports",
                            description: "Create comprehensive bug reports that enable quick identification and resolution.",
                            tips: [
                                "Use clear, descriptive titles that summarize the issue",
                                "Include environment details (OS, browser, version, etc.)",
                                "Provide step-by-step reproduction instructions",
                                "Describe expected vs. actual behavior clearly",
                                "Attach screenshots, videos, or log files when relevant",
                                "Set appropriate priority (Critical, High, Medium, Low)",
                                "Set severity based on impact (Blocker, Major, Minor, Trivial)",
                                "Include preconditions and test data used",
                                "Link to related issues or user stories",
                                "Add labels for categorization (UI, API, Performance, etc.)"
                            ],
                            resources: [
                                { title: "Bug Report Template", url: "https://www.atlassian.com/blog/jira-software/5-steps-writing-meaningful-bug-reports" },
                                { title: "Severity vs Priority", url: "https://www.atlassian.com/continuous-delivery/software-testing/types-of-software-testing" },
                                { title: "Bug Lifecycle Management", url: "https://support.atlassian.com/jira-software-cloud/docs/what-is-a-workflow/" }
                            ]
                        },
                        {
                            title: "Test Automation Tracking",
                            description: "Advanced strategies for tracking automated test coverage and results in Jira.",
                            tips: [
                                "Create custom fields to track automation coverage percentage per story",
                                "Link automated test results to Jira issues using API integrations",
                                "Set up automation to create bug issues from failed test runs",
                                "Track test execution time and performance trends",
                                "Use labels to categorize test types: unit, integration, e2e, performance",
                                "Create dashboards showing test coverage across components",
                                "Set up notifications for test failures with relevant team mentions",
                                "Track flaky test patterns and link to technical debt items"
                            ],
                            resources: [
                                { title: "Test Automation Integration", url: "https://marketplace.atlassian.com/search?query=test%20automation" },
                                { title: "CI/CD Integration", url: "https://support.atlassian.com/jira-software-cloud/docs/integrate-with-development-tools/" }
                            ]
                        },
                        {
                            title: "Quality Metrics Dashboard",
                            description: "Build comprehensive quality dashboards that aren't available out-of-the-box.",
                            tips: [
                                "Track Defect Density: (Number of Defects / Size of Release) * 100",
                                "Monitor Test Coverage: (Tested Features / Total Features) * 100",
                                "Calculate Defect Removal Efficiency: (Defects Found in Testing / Total Defects) * 100",
                                "Track Mean Time to Resolution (MTTR) for different bug severities",
                                "Monitor Regression Rate: (Regression Bugs / Total Bugs) * 100",
                                "Create Test Case Effectiveness metrics: Pass/Fail ratios over time",
                                "Track Customer-Reported vs Internal Defects ratio",
                                "Monitor Code Review Coverage and effectiveness metrics"
                            ],
                            resources: [
                                { title: "Quality Metrics Guide", url: "https://www.atlassian.com/agile/project-management/metrics" },
                                { title: "Dashboard Gadgets", url: "https://support.atlassian.com/jira-software-cloud/docs/add-gadgets-to-a-dashboard/" }
                            ]
                        }
                    ]
                },
                "business-analyst": {
                    title: "Business Analyst Best Practices",
                    practices: [
                        {
                            title: "Requirements Management",
                            description: "Capture, organize, and track business requirements effectively.",
                            tips: [
                                "Write clear, testable acceptance criteria",
                                "Use epics and stories to organize requirements",
                                "Maintain traceability between requirements and deliverables",
                                "Regular stakeholder review and validation"
                            ],
                            resources: [
                                { title: "Requirements in Agile", url: "https://www.atlassian.com/agile/project-management/user-stories" },
                                { title: "Epic Management", url: "https://support.atlassian.com/jira-software-cloud/docs/manage-epics/" }
                            ]
                        },
                        {
                            title: "Stakeholder Communication",
                            description: "Use Jira for effective stakeholder communication and reporting.",
                            tips: [
                                "Create informative dashboards for stakeholders",
                                "Use filters and JQL for targeted reporting",
                                "Regular status updates and progress tracking",
                                "Document decisions and changes"
                            ],
                            resources: [
                                { title: "Dashboard Creation", url: "https://support.atlassian.com/jira-software-cloud/docs/create-and-edit-a-dashboard/" },
                                { title: "JQL Guide", url: "https://support.atlassian.com/jira-software-cloud/docs/use-advanced-search-with-jira-query-language-jql/" }
                            ]
                        }
                    ]
                }
            };

            const data = helpData[role] || helpData.all;
            
            let html = `<div class="help-content">`;
            html += `<h4 class="mb-4"><i class="fas fa-lightbulb me-2 text-warning"></i>${data.title}</h4>`;
            
            data.practices.forEach(practice => {
                html += `
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2" style="color: #FFD700;"></i>${practice.title}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text mb-3">${practice.description}</p>
                            
                            <h6><i class="fas fa-check-circle me-2 text-success"></i>Best Practices:</h6>
                            <ul class="mb-3">
                                ${practice.tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                            
                            <h6><i class="fas fa-external-link-alt me-2 text-info"></i>Resources & Documentation:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${practice.resources.map(resource => `
                                    <a href="${resource.url}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-book me-1"></i>${resource.title}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
                                        html += `</div>`;
            
            // Add templates and examples section
            html += `
                <div class="card mb-4 bg-light">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>Templates & Examples
                        </h5>
                    </div>
                    <div class="card-body">
                        ${getTemplatesAndExamples(role)}
                    </div>
                </div>
            `;
            
            return html;
        }

        function getTemplatesAndExamples(role) {
            const templates = {
                all: `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user-story me-2 text-primary"></i>User Story Template</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Title:</strong> [Action] as [User Role]<br>
                                <strong>Description:</strong><br>
                                As a [user type]<br>
                                I want [functionality]<br>
                                So that [benefit/value]<br><br>
                                <strong>Acceptance Criteria:</strong><br>
                                Given [precondition]<br>
                                When [action]<br>
                                Then [expected result]
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-bug me-2 text-danger"></i>Bug Report Template</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Title:</strong> [Component] - Brief description<br>
                                <strong>Environment:</strong> OS, Browser, Version<br>
                                <strong>Steps to Reproduce:</strong><br>
                                1. Navigate to...<br>
                                2. Click on...<br>
                                3. Enter...<br><br>
                                <strong>Expected:</strong> [What should happen]<br>
                                <strong>Actual:</strong> [What actually happens]<br>
                                <strong>Attachments:</strong> Screenshots/logs
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><i class="fas fa-search me-2 text-info"></i>Useful JQL Queries</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Stale Issues:</strong><br>
                                <code>status changed before -30d AND status not in (Done, Closed)</code><br><br>
                                <strong>Overdue Items:</strong><br>
                                <code>due < now() AND status not in (Done, Closed)</code><br><br>
                                <strong>No Estimates:</strong><br>
                                <code>originalEstimate is EMPTY AND status not in (Done, Closed)</code>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-robot me-2 text-success"></i>Automation Examples</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Auto-assign by Component:</strong><br>
                                When: Issue Created<br>
                                If: Component = "Frontend"<br>
                                Then: Assign to {{ '{{' }}componentLead.Frontend{{ '}}' }}<br><br>
                                <strong>Stale Issue Reminder:</strong><br>
                                When: Scheduled (Weekly)<br>
                                If: Status unchanged for 14 days<br>
                                Then: Comment and @mention assignee
                            </div>
                        </div>
                    </div>
                `,
                developer: `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-code-branch me-2 text-success"></i>Smart Commit Examples</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <code>git commit -m "PROJ-123 #comment Fixed login validation bug"</code><br><br>
                                <code>git commit -m "PROJ-456 #time 2h 30m Added user authentication"</code><br><br>
                                <code>git commit -m "PROJ-789 #resolve #time 1h Fixed database connection issue"</code>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-clock me-2 text-info"></i>Work Log Examples</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Development:</strong> "Implemented user login API endpoint with JWT authentication"<br><br>
                                <strong>Bug Fix:</strong> "Debugged and fixed null pointer exception in payment processing"<br><br>
                                <strong>Code Review:</strong> "Reviewed PR #45 - user management module, provided feedback on error handling"
                            </div>
                        </div>
                    </div>
                `,
                tester: `
                    <div class="row">
                        <div class="col-md-12">
                            <h6><i class="fas fa-clipboard-check me-2 text-warning"></i>Test Case Template</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Test Case ID:</strong> TC_LOGIN_001<br>
                                <strong>Test Scenario:</strong> Verify successful login with valid credentials<br>
                                <strong>Prerequisites:</strong> User account exists in system<br>
                                <strong>Test Steps:</strong><br>
                                1. Navigate to login page<br>
                                2. Enter valid username and password<br>
                                3. Click login button<br>
                                <strong>Expected Result:</strong> User is redirected to dashboard<br>
                                <strong>Test Data:</strong> username: testuser@example.com, password: Test123!
                            </div>
                        </div>
                    </div>
                `,
                "project-manager": `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-tasks me-2 text-primary"></i>Sprint Goal Template</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Sprint Goal:</strong> "Enable users to complete the checkout process"<br><br>
                                <strong>Success Criteria:</strong><br>
                                ‚Ä¢ Payment processing is functional<br>
                                ‚Ä¢ Order confirmation is sent<br>
                                ‚Ä¢ Inventory is updated<br>
                                ‚Ä¢ User receives receipt
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-line me-2 text-info"></i>Definition of Done</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                ‚úì Code is written and reviewed<br>
                                ‚úì Unit tests are written and passing<br>
                                ‚úì Integration tests are passing<br>
                                ‚úì Documentation is updated<br>
                                ‚úì Feature is deployed to staging<br>
                                ‚úì Acceptance criteria are met<br>
                                ‚úì Stakeholder approval received
                            </div>
                        </div>
                    </div>
                `,
                "scrum-master": `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Impediment Template</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Impediment:</strong> Blocked API access for payment integration<br>
                                <strong>Impact:</strong> Cannot complete checkout feature (3 stories blocked)<br>
                                <strong>Owner:</strong> John Doe (Infrastructure Team)<br>
                                <strong>Target Resolution:</strong> End of week<br>
                                <strong>Workaround:</strong> Using mock payment service for testing
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-history me-2 text-success"></i>Retrospective Action Item</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Action:</strong> Implement daily code review sessions<br>
                                <strong>Why:</strong> Reduce bugs found in QA by 50%<br>
                                <strong>Owner:</strong> Development Team<br>
                                <strong>Due Date:</strong> Next Sprint<br>
                                <strong>Success Metric:</strong> Bug count in QA phase
                            </div>
                        </div>
                    </div>
                `,
                "business-analyst": `
                    <div class="row">
                        <div class="col-md-12">
                            <h6><i class="fas fa-file-alt me-2 text-info"></i>Requirements Template</h6>
                            <div class="bg-white p-3 border rounded mb-3">
                                <strong>Requirement ID:</strong> REQ-001<br>
                                <strong>Title:</strong> User Registration System<br>
                                <strong>Description:</strong> System shall allow new users to create accounts<br>
                                <strong>Business Rule:</strong> Email must be unique, password minimum 8 characters<br>
                                <strong>Priority:</strong> High<br>
                                <strong>Source:</strong> Stakeholder Workshop 2024-01-15<br>
                                <strong>Acceptance Criteria:</strong><br>
                                ‚Ä¢ User can enter email and password<br>
                                ‚Ä¢ System validates email format<br>
                                ‚Ä¢ System checks password strength<br>
                                ‚Ä¢ Confirmation email is sent
                            </div>
                        </div>
                    </div>
                `
            };
            
            return templates[role] || templates.all;
        }

        // Initialize Help section role selector
        document.addEventListener('DOMContentLoaded', function() {
            const roleButtons = document.querySelectorAll('#roleSelector .list-group-item');
            roleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    roleButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    // Load content for selected role
                    const role = this.getAttribute('data-role');
                    loadHelpContent(role);
                });
            });
        });

        // Analytics functionality
        async function initializeAnalytics() {
            try {
                const response = await fetch('/api/analytics/session/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    analyticsSessionId = data.session_id;
                    
                    // Track initial page view
                    trackPageView('Sprint Report');
                    
                    // Set up automatic tracking
                    trackUserInteractions();
                    
                    console.log('Analytics initialized successfully with optimized tracking');
                    console.log('- Button clicks: 1 second cooldown, important buttons only');
                    console.log('- Page views: 2 second cooldown, duplicate prevention');
                    console.log('- Batch processing: 500ms debounce, deduplication');
                } else {
                    console.warn('Failed to initialize analytics');
                }
            } catch (error) {
                console.warn('Analytics initialization error:', error);
            }
        }

        // Debouncing to prevent excessive analytics calls
        let trackingQueue = new Map();
        let trackingTimer = null;

        function trackEvent(eventType, data) {
            if (!analyticsSessionId) return;
            
            try {
                // Create a unique key for deduplication
                const eventKey = `${eventType}_${JSON.stringify(data)}`;
                
                // Add to queue instead of sending immediately
                trackingQueue.set(eventKey, {
                    session_id: analyticsSessionId,
                    event_type: eventType,
                    ...data
                });
                
                // Debounce: only send after 500ms of no new events
                clearTimeout(trackingTimer);
                trackingTimer = setTimeout(flushTrackingQueue, 500);
                
            } catch (error) {
                console.warn('Analytics tracking error:', error);
            }
        }

        function flushTrackingQueue() {
            if (trackingQueue.size === 0) return;
            
            // Send only the most recent unique events
            const eventsToSend = Array.from(trackingQueue.values());
            const eventCount = eventsToSend.length;
            trackingQueue.clear();
            
            console.log(`üìä Sending ${eventCount} analytics events in batch`);
            
            // Send in batch to reduce API calls
            fetch('/api/analytics/track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    events: eventsToSend
                })
            }).then(response => response.json())
            .then(data => {
                console.log(`‚úÖ Analytics batch processed: ${data.processed_count}/${data.total_events} events`);
            }).catch(error => {
                console.warn('Analytics batch tracking error:', error);
            });
        }

        let lastPageView = '';
        let lastPageViewTime = 0;
        let pageViewCooldown = 2000; // 2 seconds cooldown between page views

        function trackPageView(pageName) {
            // Prevent duplicate page views within cooldown period
            const now = Date.now();
            if (pageName === lastPageView && now - lastPageViewTime < pageViewCooldown) {
                return;
            }
            
            lastPageView = pageName;
            lastPageViewTime = now;
            
            trackEvent('page_view', {
                page_name: pageName,
                url: window.location.href
            });
        }

        function trackButtonClick(buttonElement, featureName) {
            const buttonText = buttonElement.textContent.trim();
            const buttonId = buttonElement.id || 'unknown';
            
            trackEvent('button_click', {
                button_id: buttonId,
                button_text: buttonText,
                feature_name: featureName
            });
        }

        function trackFeatureUsage(featureName, action, metadata = {}) {
            trackEvent('feature_usage', {
                feature_name: featureName,
                action: action,
                metadata: metadata
            });
        }

        function trackPerformanceMetric(metricName, value, metadata = {}) {
            trackEvent('performance_metric', {
                metric_name: metricName,
                value: value,
                metadata: metadata
            });
        }

        let lastButtonClickTime = 0;
        let buttonClickCooldown = 1000; // 1 second cooldown between button clicks

        function trackUserInteractions() {
            // Track important button clicks only (with cooldown to prevent spam)
            document.addEventListener('click', function(event) {
                if (event.target.tagName === 'BUTTON' || event.target.closest('button')) {
                    const button = event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button');
                    
                    // Skip if this is a rapid-fire click (less than 1 second since last click)
                    const now = Date.now();
                    if (now - lastButtonClickTime < buttonClickCooldown) {
                        return;
                    }
                    lastButtonClickTime = now;
                    
                    // Only track important buttons, not every single button
                    if (button.id && (
                        button.id.includes('generate') ||
                        button.id.includes('extract') ||
                        button.id.includes('download') ||
                        button.id.includes('share') ||
                        button.classList.contains('nav-link')
                    )) {
                        // Determine feature name based on button context
                        let featureName = 'Unknown';
                        if (button.closest('#sprintReportSection')) {
                            featureName = 'Sprint Report';
                        
                        } else if (button.closest('#capacityPlanningSection')) {
                            featureName = 'Capacity Planning';
                        } else if (button.closest('#analyticsSection')) {
                            featureName = 'Analytics';
                        } else if (button.closest('#settingsModal')) {
                            featureName = 'Settings';
                        } else if (button.classList.contains('nav-link')) {
                            featureName = 'Navigation';
                        }
                        
                        trackButtonClick(button, featureName);
                    }
                }
            });
        }

        async function loadAnalyticsData() {
            try {
                const timeRange = document.getElementById('analyticsTimeRange').value;
                const response = await fetch(`/api/analytics/summary?days_back=${timeRange}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load analytics data');
                }
                
                const data = await response.json();
                updateAnalyticsDashboard(data);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showAnalyticsError('Failed to load analytics data');
            }
        }

        function updateAnalyticsDashboard(data) {
            // Update summary cards
            document.getElementById('totalUsersCount').textContent = data.summary.unique_users;
            document.getElementById('totalSessionsCount').textContent = data.summary.total_sessions;
            document.getElementById('totalClicksCount').textContent = data.summary.total_button_clicks;
            document.getElementById('engagementScore').textContent = data.engagement_score;
            
            // Update feature usage chart
            updateFeatureUsageChart(data.top_features);
            
            // Update daily activity chart
            updateDailyActivityChart(data.daily_activity);
            
            // Update tables
            updateTopButtonsTable(data.top_buttons, data.summary.total_button_clicks);
            updateTopPagesTable(data.top_pages, data.summary.total_page_views);
            
            // Update performance metrics
            updatePerformanceMetrics(data.performance_metrics);
        }

        function updateFeatureUsageChart(featureData) {
            const ctx = document.getElementById('featureUsageChart').getContext('2d');
            
            // Destroy existing chart
            if (analyticsCharts.featureUsage) {
                analyticsCharts.featureUsage.destroy();
            }
            
            const labels = Object.keys(featureData);
            const values = Object.values(featureData);
            
            analyticsCharts.featureUsage = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateDailyActivityChart(dailyData) {
            const ctx = document.getElementById('dailyActivityChart').getContext('2d');
            
            // Destroy existing chart
            if (analyticsCharts.dailyActivity) {
                analyticsCharts.dailyActivity.destroy();
            }
            
            const sortedDates = Object.keys(dailyData).sort();
            const sessions = sortedDates.map(date => dailyData[date].sessions);
            const clicks = sortedDates.map(date => dailyData[date].button_clicks);
            const users = sortedDates.map(date => dailyData[date].unique_users);
            
            analyticsCharts.dailyActivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [
                        {
                            label: 'Sessions',
                            data: sessions,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Button Clicks',
                            data: clicks,
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: false
                        },
                        {
                            label: 'Unique Users',
                            data: users,
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopButtonsTable(buttonData, totalClicks) {
            const tbody = document.getElementById('topButtonsTable');
            tbody.innerHTML = '';
            
            if (Object.keys(buttonData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
                return;
            }
            
            Object.entries(buttonData).forEach(([button, clicks]) => {
                const percentage = ((clicks / totalClicks) * 100).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${button}</td>
                    <td>${clicks}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTopPagesTable(pageData, totalViews) {
            const tbody = document.getElementById('topPagesTable');
            tbody.innerHTML = '';
            
            if (Object.keys(pageData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
                return;
            }
            
            Object.entries(pageData).forEach(([page, views]) => {
                const percentage = ((views / totalViews) * 100).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${page}</td>
                    <td>${views}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePerformanceMetrics(metricsData) {
            const container = document.getElementById('performanceMetrics');
            
            if (Object.keys(metricsData).length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No performance data available</div>';
                return;
            }
            
            let html = '<div class="row">';
            Object.entries(metricsData).forEach(([metric, data]) => {
                html += `
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">${metric.replace(/_/g, ' ').toUpperCase()}</h6>
                                <div class="mb-2">
                                    <small class="text-muted">Average:</small>
                                    <div class="h5">${data.average.toFixed(2)}ms</div>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span>Min: ${data.min.toFixed(2)}ms</span>
                                    <span>Max: ${data.max.toFixed(2)}ms</span>
                                </div>
                                <div class="small text-muted">Samples: ${data.count}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function showAnalyticsError(message) {
            const container = document.getElementById('analyticsSummaryCards');
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                </div>
            `;
        }

        // Analytics event listeners
        const analyticsTimeRange = document.getElementById('analyticsTimeRange');
        const refreshAnalyticsBtn = document.getElementById('refreshAnalyticsBtn');
        
        if (analyticsTimeRange) {
            analyticsTimeRange.addEventListener('change', loadAnalyticsData);
        }
        if (refreshAnalyticsBtn) {
            refreshAnalyticsBtn.addEventListener('click', loadAnalyticsData);
        }

        // Initialize analytics when page loads - TEMPORARILY DISABLED
        // document.addEventListener('DOMContentLoaded', function() {
        //     initializeAnalytics();
        // });

        // Track feature usage for existing functionality
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            const startTime = performance.now();
            
            return originalFetch.apply(this, args).then(response => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                // Track API performance
                if (url.includes('/api/')) {
                    const apiEndpoint = url.split('/api/')[1].split('?')[0];
                    trackPerformanceMetric(`api_${apiEndpoint}`, duration);
                }
                
                return response;
            });
        };

        // AI Insights functionality
        let currentSprintDataForAI = null;

        // Generate AI Insights - Moved to DOMContentLoaded event handler

        // Regenerate insights button
        const regenerateInsightsBtn = document.getElementById('regenerateInsightsBtn');
        if (regenerateInsightsBtn) {
            regenerateInsightsBtn.addEventListener('click', async function() {
                if (currentSprintReportData && currentSprintReportData.report) {
                    await generateAIInsights(currentSprintReportData.report);
                }
            });
        }

        async function generateAIInsights(sprintData) {
            const loadingEl = document.getElementById('aiInsightsLoading');
            const errorEl = document.getElementById('aiInsightsError');
            const resultsEl = document.getElementById('aiInsightsResults');
            const button = document.getElementById('generateAIInsightsBtn');
            const regenerateBtn = document.getElementById('regenerateInsightsBtn');

            // Reset states
            loadingEl.style.display = '';
            errorEl.style.display = 'none';
            resultsEl.style.display = 'none';
            regenerateBtn.style.display = 'none';
            button.disabled = true;

            try {
                const response = await fetch('/api/sprint/ai-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sprint_data: sprintData
                    })
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    displayAIInsights(data.insights);
                    resultsEl.style.display = '';
                    regenerateBtn.style.display = '';
                    showToast('AI insights generated successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to generate insights');
                }
            } catch (error) {
                console.error('AI Insights error:', error);
                if (error.message.includes('OpenAI') || error.message.includes('API key')) {
                    errorEl.style.display = '';
                } else {
                    errorEl.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Analysis Failed</strong>
                                <p class="mb-0">${error.message}</p>
                            </div>
                        </div>
                    `;
                    errorEl.style.display = '';
                }
            } finally {
                loadingEl.style.display = 'none';
                button.disabled = false;
            }
        }

        function displayAIInsights(insights) {
            const insightsList = document.getElementById('aiInsightsList');
            const overallAssessment = document.getElementById('overallAssessment');
            const keyObservations = document.getElementById('keyObservations');

            // Clear previous content
            insightsList.innerHTML = '';
            keyObservations.innerHTML = '';

            // Display overall assessment
            overallAssessment.innerHTML = `
                <p class="mb-0">${insights.overall_assessment}</p>
            `;

            // Display insights in a clean modal format
            if (insights.insights && insights.insights.length > 0) {
                insights.insights.forEach((insight, index) => {
                    const impactBadge = insight.impact === 'High' ? 'danger' : 
                                       insight.impact === 'Medium' ? 'warning' : 'info';
                    
                    const categoryIcon = insight.category === 'Planning' ? 'calendar-alt' :
                                        insight.category === 'Execution' ? 'play-circle' :
                                        insight.category === 'Team' ? 'users' : 'cogs';

                    insightsList.innerHTML += `
                        <div class="card mb-3 border-start border-${impactBadge} border-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 text-primary">
                                        <i class="fas fa-${categoryIcon} me-2"></i>${insight.title}
                                    </h6>
                                    <div class="d-flex gap-1">
                                        <span class="badge bg-light text-dark">${insight.category}</span>
                                        <span class="badge bg-${impactBadge}">${insight.impact}</span>
                                    </div>
                                </div>
                                <p class="card-text text-dark">${insight.description}</p>
                            </div>
                        </div>
                    `;
                });
            }

            // Display key observations
            if (insights.key_observations && insights.key_observations.length > 0) {
                insights.key_observations.forEach(observation => {
                    keyObservations.innerHTML += `<li>${observation}</li>`;
                });
            }

            // Show if fallback was used
            if (insights.fallback) {
                overallAssessment.innerHTML += `
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-info-circle me-1"></i>
                        Basic analysis used (OpenAI not available)
                    </small>
                `;
                
                // Show debug information if available
                if (insights.raw_openai_response) {
                    overallAssessment.innerHTML += `
                        <div class="mt-3 p-3 bg-light border rounded">
                            <h6 class="text-danger mb-2">
                                <i class="fas fa-bug me-2"></i>Debug Information
                            </h6>
                            <div class="mb-2">
                                <strong>Raw OpenAI Response:</strong>
                                <pre class="mt-1 p-2 bg-white border rounded" style="font-size: 0.8em; max-height: 200px; overflow-y: auto;">${insights.raw_openai_response}</pre>
                            </div>
                            ${insights.error ? `<div class="mb-2"><strong>Error:</strong> ${insights.error}</div>` : ''}
                            ${insights.json_error ? `<div class="mb-2"><strong>JSON Error:</strong> ${insights.json_error}</div>` : ''}
                        </div>
                    `;
                }
            }
        }

        // OpenAI Configuration - Wrap in DOMContentLoaded to ensure elements exist
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üî• OpenAI Configuration: DOMContentLoaded event fired');
            
            // Check if elements exist
            const testBtn = document.getElementById('testOpenaiConnection');
            const saveBtn = document.getElementById('saveOpenaiConfig');
            const apiKeyInput = document.getElementById('openaiApiKey');
            
            console.log('üîç OpenAI Elements Check:');
            console.log('  - Test button:', testBtn ? '‚úÖ Found' : '‚ùå Missing');
            console.log('  - Save button:', saveBtn ? '‚úÖ Found' : '‚ùå Missing');
            console.log('  - API Key input:', apiKeyInput ? '‚úÖ Found' : '‚ùå Missing');
            
            if (!testBtn) {
                console.error('‚ùå CRITICAL: testOpenaiConnection button not found!');
                alert('ERROR: Test Connection button not found in DOM!');
                return;
            }
            
            if (!saveBtn) {
                console.error('‚ùå CRITICAL: saveOpenaiConfig button not found!');
                alert('ERROR: Save Configuration button not found in DOM!');
                return;
            }
            
            if (!apiKeyInput) {
                console.error('‚ùå CRITICAL: openaiApiKey input not found!');
                alert('ERROR: API Key input field not found in DOM!');
                return;
            }
            
            console.log('‚úÖ All OpenAI elements found, attaching event listeners...');
            
            // Test Connection Button
            testBtn.addEventListener('click', async function() {
                console.log('üî• TEST CONNECTION BUTTON CLICKED! üî•');
                
                const apiKey = apiKeyInput.value.trim();
                console.log('üìù API Key check:', apiKey ? `Present (${apiKey.length} chars)` : 'Empty');
                
                if (!apiKey) {
                    console.warn('‚ö†Ô∏è No API key provided');
                    showToast('Please enter an OpenAI API key', 'warning');
                    alert('Please enter an OpenAI API key');
                    return;
                }

                const button = this;
                const originalText = button.innerHTML;
                console.log('üîÑ Starting test connection process...');
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
                button.disabled = true;

                try {
                    console.log('üì° Making API request to /api/settings/test-openai');
                    console.log('üì§ Request payload:', { api_key: apiKey.substring(0, 10) + '...' });
                    
                    const response = await fetch('/api/settings/test-openai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            api_key: apiKey
                        })
                    });

                    console.log('üì• Response status:', response.status);
                    console.log('üì• Response ok:', response.ok);
                    
                    const data = await response.json();
                    console.log('üì• Response data:', data);

                    if (response.ok) {
                        console.log('‚úÖ Test connection successful!');
                        document.getElementById('aiConnectionStatus').innerHTML = `
                            <div class="text-success">
                                <i class="fas fa-check-circle me-2"></i>Connection successful
                            </div>
                        `;
                        showToast('OpenAI connection test successful!', 'success');
                        alert('‚úÖ SUCCESS: OpenAI connection test successful!');
                    } else {
                        console.error('‚ùå Test connection failed:', data.error);
                        throw new Error(data.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('üí• Test connection error:', error);
                    console.error('üí• Error details:', error.message, error.stack);
                    
                    document.getElementById('aiConnectionStatus').innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-times-circle me-2"></i>Connection failed
                        </div>
                    `;
                    const errorMsg = 'Connection test failed: ' + error.message;
                    showToast(errorMsg, 'error');
                    alert('‚ùå ERROR: ' + errorMsg);
                } finally {
                    console.log('üîÑ Resetting button state...');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            });
            
            console.log('‚úÖ Test connection event listener attached');

            // Save Configuration Button
            saveBtn.addEventListener('click', async function() {
                console.log('üíæ SAVE CONFIGURATION BUTTON CLICKED! üíæ');
                
                const apiKey = apiKeyInput.value.trim();
                console.log('üìù API Key check for save:', apiKey ? `Present (${apiKey.length} chars)` : 'Empty');
                
                if (!apiKey) {
                    console.warn('‚ö†Ô∏è No API key provided for save');
                    showToast('Please enter an OpenAI API key', 'warning');
                    alert('Please enter an OpenAI API key');
                    return;
                }

                const button = this;
                const originalText = button.innerHTML;
                console.log('üîÑ Starting save configuration process...');
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                button.disabled = true;

                try {
                    console.log('üì° Making API request to /api/settings/save-openai');
                    console.log('üì§ Save request payload:', { api_key: apiKey.substring(0, 10) + '...' });
                    
                    const response = await fetch('/api/settings/save-openai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            api_key: apiKey
                        })
                    });

                    console.log('üì• Save response status:', response.status);
                    console.log('üì• Save response ok:', response.ok);
                    
                    const data = await response.json();
                    console.log('üì• Save response data:', data);

                    if (response.ok) {
                        console.log('‚úÖ Save configuration successful!');
                        showToast('OpenAI API key saved successfully!', 'success');
                        alert('‚úÖ SUCCESS: OpenAI API key saved successfully!');
                        loadOpenaiConfig(); // Refresh the display
                        apiKeyInput.value = ''; // Clear the input
                    } else {
                        console.error('‚ùå Save configuration failed:', data.error);
                        throw new Error(data.error || 'Unknown save error');
                    }
                } catch (error) {
                    console.error('üí• Save configuration error:', error);
                    console.error('üí• Save error details:', error.message, error.stack);
                    
                    const errorMsg = 'Failed to save OpenAI API key: ' + error.message;
                    showToast(errorMsg, 'error');
                    alert('‚ùå ERROR: ' + errorMsg);
                } finally {
                    console.log('üîÑ Resetting save button state...');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            });
            
            console.log('‚úÖ Save configuration event listener attached');

            // Toggle API Key Visibility Button
            const toggleBtn = document.getElementById('toggleOpenaiApiKey');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    console.log('üëÅÔ∏è Toggle API key visibility clicked');
                    const input = document.getElementById('openaiApiKey');
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                        console.log('üëÅÔ∏è API key visibility: SHOWN');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                        console.log('üëÅÔ∏è API key visibility: HIDDEN');
                    }
                });
                console.log('‚úÖ Toggle visibility event listener attached');
            } else {
                console.warn('‚ö†Ô∏è Toggle API key button not found');
            }

            // Show Masked Key Button
            const showMaskedBtn = document.getElementById('showMaskedOpenaiKey');
            if (showMaskedBtn) {
                showMaskedBtn.addEventListener('click', function() {
                    console.log('üîç Show masked key clicked');
                    const display = document.getElementById('maskedOpenaiKeyDisplay');
                    display.style.display = display.style.display === 'none' ? '' : 'none';
                    console.log('üîç Masked key display toggled:', display.style.display === 'none' ? 'HIDDEN' : 'SHOWN');
                });
                console.log('‚úÖ Show masked key event listener attached');
            } else {
                console.warn('‚ö†Ô∏è Show masked key button not found');
            }

            async function loadOpenaiConfig() {
                console.log('üì• Loading OpenAI configuration...');
                try {
                    const response = await fetch('/api/settings/load-openai');
                    console.log('üì• Load config response status:', response.status);
                    
                    const data = await response.json();
                    console.log('üì• Load config response data:', data);

                    if (response.ok) {
                        const statusEl = document.getElementById('openaiKeyStatus');
                        const maskedTextEl = document.getElementById('maskedOpenaiKeyText');
                        const connectionStatusEl = document.getElementById('aiConnectionStatus');

                        console.log('üîç Config elements check:');
                        console.log('  - Status element:', statusEl ? '‚úÖ Found' : '‚ùå Missing');
                        console.log('  - Masked text element:', maskedTextEl ? '‚úÖ Found' : '‚ùå Missing');
                        console.log('  - Connection status element:', connectionStatusEl ? '‚úÖ Found' : '‚ùå Missing');

                        if (data.has_key) {
                            console.log('üîë API key is configured');
                            if (statusEl) statusEl.style.display = '';
                            if (maskedTextEl) maskedTextEl.textContent = data.masked_key;
                            
                            if (data.ai_enabled) {
                                console.log('‚úÖ AI is enabled and ready');
                                if (connectionStatusEl) {
                                    connectionStatusEl.innerHTML = `
                                        <div class="text-success">
                                            <i class="fas fa-check-circle me-2"></i>AI Ready
                                        </div>
                                    `;
                                }
                            } else {
                                console.log('‚ö†Ô∏è AI key configured but restart required');
                                if (connectionStatusEl) {
                                    connectionStatusEl.innerHTML = `
                                        <div class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Key configured, restart required
                                        </div>
                                    `;
                                }
                            }
                        } else {
                            console.log('‚ùå No API key configured');
                            if (statusEl) statusEl.style.display = 'none';
                            if (connectionStatusEl) {
                                connectionStatusEl.innerHTML = `
                                    <div class="text-muted">
                                        <i class="fas fa-question-circle me-2"></i>Not configured
                                    </div>
                                `;
                            }
                        }
                    } else {
                        console.error('‚ùå Failed to load OpenAI config:', data);
                    }
                } catch (error) {
                    console.error('üí• Error loading OpenAI config:', error);
                    console.error('üí• Load config error details:', error.message, error.stack);
                }
            }

            // Load OpenAI config when AI tab is shown
            const aiConfigTab = document.getElementById('ai-config-tab');
            if (aiConfigTab) {
                aiConfigTab.addEventListener('click', function() {
                    console.log('üéØ AI Configuration tab clicked');
                    loadOpenaiConfig();
                });
                console.log('‚úÖ AI config tab event listener attached');
            } else {
                console.warn('‚ö†Ô∏è AI config tab not found');
            }
        }); // End of DOMContentLoaded for OpenAI Configuration


        


        // Global variable to store projects data
        let allProjectsData = [];
        let filteredProjectsData = [];

        // Load detailed projects data
        async function loadProjectsData() {
            console.log('loadProjectsData called');
            const loadingEl = document.getElementById('projectsLoading');
            const errorEl = document.getElementById('projectsError');
            const tableBody = document.getElementById('projectsTableBody');
            
            console.log('Setting loading state');
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            
            try {
                console.log('Making API request to /api/projects_detailed');
                const response = await fetch('/api/projects_detailed');
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API response data:', data);
                allProjectsData = data.projects || [];
                filteredProjectsData = [...allProjectsData];
                
                console.log(`Loaded ${allProjectsData.length} projects`);
                updateProjectsTable();
                updateProjectsCount();
                
            } catch (error) {
                console.error('Error loading projects:', error);
                errorEl.style.display = 'block';
                errorEl.textContent = `Failed to load projects: ${error.message}`;
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>Failed to load projects
                        </td>
                    </tr>
                `;
            } finally {
                console.log('Hiding loading state');
                loadingEl.style.display = 'none';
            }
        }

        // Update projects table
        function updateProjectsTable() {
            const tableBody = document.getElementById('projectsTableBody');
            
            if (filteredProjectsData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>No projects found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredProjectsData.map(project => {
                const statusBadge = getStatusBadge(project.status);
                const daysBadge = getDaysBadge(project.daysSinceActivity);
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary text-white rounded me-2 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div>
                                    <strong>${project.name}</strong>
                                    <br>
                                    <small class="text-muted">${project.description}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark font-monospace">${project.key}</span>
                        </td>
                        <td>
                            <span class="badge bg-secondary">${project.type}</span>
                        </td>
                        <td>
                            <span class="text-muted">${project.lastActivity || 'N/A'}</span>
                        </td>
                        <td>${daysBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="openProjectInJira('${project.key}')" title="Open in Jira">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="viewProjectDetails('${project.key}')" title="View Details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Helper functions for badges
        function getStatusBadge(status) {
            const badgeClasses = {
                'Very Active': 'bg-success',
                'Active': 'bg-primary',
                'Moderate': 'bg-warning',
                'Inactive': 'bg-danger',
                'Unknown': 'bg-secondary'
            };
            
            return `<span class="badge ${badgeClasses[status] || 'bg-secondary'}">${status}</span>`;
        }

        function getDaysBadge(days) {
            if (days === null || days === undefined) {
                return '<span class="badge bg-secondary">N/A</span>';
            }
            
            let badgeClass = 'bg-secondary';
            if (days <= 7) badgeClass = 'bg-success';
            else if (days <= 30) badgeClass = 'bg-primary';
            else if (days <= 90) badgeClass = 'bg-warning';
            else badgeClass = 'bg-danger';
            
            return `<span class="badge ${badgeClass}">${days} days</span>`;
        }

        // Update projects count
        function updateProjectsCount() {
            const countEl = document.getElementById('projectsCount');
            countEl.textContent = `${filteredProjectsData.length} of ${allProjectsData.length} projects`;
        }

        // Filter projects
        function filterProjects() {
            const searchTerm = document.getElementById('projectSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('projectStatusFilter').value;
            
            filteredProjectsData = allProjectsData.filter(project => {
                const matchesSearch = project.name.toLowerCase().includes(searchTerm) || 
                                    project.key.toLowerCase().includes(searchTerm) ||
                                    project.description.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || 
                                    (statusFilter === 'active' && ['Very Active', 'Active', 'Moderate'].includes(project.status)) ||
                                    (statusFilter === 'inactive' && project.status === 'Inactive');
                
                return matchesSearch && matchesStatus;
            });
            
            updateProjectsTable();
            updateProjectsCount();
        }

        // Helper functions for actions
        function openProjectInJira(projectKey) {
            // This would need the Jira URL from settings
            const jiraUrl = 'https://your-domain.atlassian.net'; // This should be dynamic
            window.open(`${jiraUrl}/projects/${projectKey}`, '_blank');
        }

        function viewProjectDetails(projectKey) {
            const project = allProjectsData.find(p => p.key === projectKey);
            if (project) {
                alert(`Project: ${project.name}\nKey: ${project.key}\nType: ${project.type}\nLead: ${project.lead}\nLast Activity: ${project.lastActivity}\nStatus: ${project.status}`);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            
            // Total Projects card click handler
            const totalProjectsCard = document.getElementById('totalProjectsCard');
            if (totalProjectsCard) {
                totalProjectsCard.addEventListener('click', function() {
                    console.log('Total Projects card clicked');
                    // Force load projects data when card is clicked
                    loadProjectsData();
                });
            }
            
            // Projects modal event listeners
            const projectsModal = document.getElementById('projectsModal');
            if (projectsModal) {
                projectsModal.addEventListener('shown.bs.modal', function() {
                    console.log('Projects modal shown');
                    if (allProjectsData.length === 0) {
                        console.log('Loading projects data...');
                        loadProjectsData();
                    }
                });
                
                projectsModal.addEventListener('show.bs.modal', function() {
                    console.log('Projects modal showing');
                    // Also try loading when modal starts to show
                    if (allProjectsData.length === 0) {
                        loadProjectsData();
                    }
                });
            }
            
            // Search and filter event listeners
            const searchInput = document.getElementById('projectSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterProjects);
            }
            
            const statusFilter = document.getElementById('projectStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', filterProjects);
            }
            
            // Refresh projects button
            const refreshProjectsBtn = document.getElementById('refreshProjectsBtn');
            if (refreshProjectsBtn) {
                refreshProjectsBtn.addEventListener('click', loadProjectsData);
            }
            
            // Total Users card click handler
            const totalUsersCard = document.getElementById('totalUsersCard');
            if (totalUsersCard) {
                totalUsersCard.addEventListener('click', function() {
                    console.log('Total Users card clicked');
                    // Force load users data when card is clicked
                    loadUsersData();
                });
            }
            
            // Users modal event listeners
            const usersModal = document.getElementById('usersModal');
            if (usersModal) {
                usersModal.addEventListener('shown.bs.modal', function() {
                    console.log('Users modal shown');
                    if (allUsersData.length === 0) {
                        console.log('Loading users data...');
                        loadUsersData();
                    }
                });
                
                usersModal.addEventListener('show.bs.modal', function() {
                    console.log('Users modal showing');
                    // Also try loading when modal starts to show
                    if (allUsersData.length === 0) {
                        loadUsersData();
                    }
                });
            }
            
            // Users search and filter event listeners
            const userSearchInput = document.getElementById('userSearchInput');
            if (userSearchInput) {
                userSearchInput.addEventListener('input', filterUsers);
            }
            
            const userStatusFilter = document.getElementById('userStatusFilter');
            if (userStatusFilter) {
                userStatusFilter.addEventListener('change', filterUsers);
            }
            
            // Refresh users button
            const refreshUsersBtn = document.getElementById('refreshUsersBtn');
            if (refreshUsersBtn) {
                refreshUsersBtn.addEventListener('click', loadUsersData);
            }
            
            // AI Insights button
            const aiInsightsBtn = document.getElementById('generateAIInsightsBtn');
            console.log('AI Insights button found in DOMContentLoaded:', aiInsightsBtn);
            
            if (aiInsightsBtn) {
                aiInsightsBtn.addEventListener('click', async function() {
                    console.log('AI Insights button clicked!');
                
                    // Open the modal first
                    const modal = new bootstrap.Modal(document.getElementById('aiInsightsModal'));
                    console.log('Modal created, showing modal...');
                    modal.show();
                    
                    if (!currentSprintReportData || !currentSprintReportData.report) {
                        // Show helpful message if no sprint data
                        const resultsEl = document.getElementById('aiInsightsResults');
                        const loadingEl = document.getElementById('aiInsightsLoading');
                        const errorEl = document.getElementById('aiInsightsError');
                        
                        loadingEl.style.display = 'none';
                        resultsEl.style.display = 'none';
                        errorEl.style.display = '';
                        errorEl.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                                <h5>No Sprint Data Available</h5>
                                <p class="text-muted mb-3">To generate AI insights, you need to:</p>
                                <ol class="text-start d-inline-block">
                                    <li>Enter a Jira board URL or Board ID</li>
                                    <li>Click "Generate Report" to load sprint data</li>
                                    <li>Then return here to get AI-powered insights</li>
                                </ol>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="bootstrap.Modal.getInstance(document.getElementById('aiInsightsModal')).hide()">
                                        <i class="fas fa-arrow-left me-2"></i>Go Generate Sprint Report
                                    </button>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    // Start AI analysis
                    await generateAIInsights(currentSprintReportData.report);
                });
            } else {
                console.error('AI Insights button not found in DOM!');
            }
        });

        // Users data variables
        let allUsersData = [];
        let filteredUsersData = [];

        // Load detailed users data
        async function loadUsersData() {
            console.log('loadUsersData called');
            const loadingEl = document.getElementById('usersLoading');
            const errorEl = document.getElementById('usersError');
            const tableBody = document.getElementById('usersTableBody');
            
            console.log('Setting loading state');
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            
            try {
                console.log('Making API request to /api/users_detailed');
                const response = await fetch('/api/users_detailed');
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API response data:', data);
                allUsersData = data.users || [];
                filteredUsersData = [...allUsersData];
                
                console.log(`Loaded ${allUsersData.length} users`);
                updateUsersTable();
                updateUsersCount();
                
            } catch (error) {
                console.error('Error loading users:', error);
                errorEl.style.display = 'block';
                errorEl.textContent = `Failed to load users: ${error.message}`;
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>Failed to load users
                        </td>
                    </tr>
                `;
            } finally {
                console.log('Hiding loading state');
                loadingEl.style.display = 'none';
            }
        }

        // Update users table
        function updateUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            
            if (filteredUsersData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>No users found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredUsersData.map(user => {
                const statusBadge = getUserStatusBadge(user.status);
                const daysBadge = getDaysBadge(user.daysSinceActivity);
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-success text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <strong>${user.displayName}</strong>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="text-muted">${user.emailAddress}</span>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <span class="text-muted">${user.lastActivity || 'N/A'}</span>
                        </td>
                        <td>${daysBadge}</td>
                        <td>
                            <span class="badge bg-secondary">${user.licenseType}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="openUserInJira('${user.accountId}')" title="Open in Jira">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="viewUserDetails('${user.accountId}')" title="View Details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Helper function for user status badges
        function getUserStatusBadge(status) {
            const badgeClasses = {
                'Active': 'bg-success',
                'Inactive': 'bg-danger',
                'Unknown': 'bg-secondary'
            };
            
            return `<span class="badge ${badgeClasses[status] || 'bg-secondary'}">${status}</span>`;
        }

        // Update users count
        function updateUsersCount() {
            const countEl = document.getElementById('usersCount');
            countEl.textContent = `${filteredUsersData.length} of ${allUsersData.length} users`;
        }

        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('userStatusFilter').value;
            
            filteredUsersData = allUsersData.filter(user => {
                const matchesSearch = user.displayName.toLowerCase().includes(searchTerm) || 
                                    user.emailAddress.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || 
                                    (statusFilter === 'active' && user.status === 'Active') ||
                                    (statusFilter === 'inactive' && user.status === 'Inactive');
                
                return matchesSearch && matchesStatus;
            });
            
            updateUsersTable();
            updateUsersCount();
        }

        // Helper functions for user actions
        function openUserInJira(accountId) {
            // This would need the Jira URL from settings
            const jiraUrl = 'https://your-domain.atlassian.net'; // This should be dynamic
            window.open(`${jiraUrl}/people/${accountId}`, '_blank');
        }

        function viewUserDetails(accountId) {
            const user = allUsersData.find(u => u.accountId === accountId);
            if (user) {
                alert(`User: ${user.displayName}\nEmail: ${user.emailAddress}\nStatus: ${user.status}\nLast Activity: ${user.lastActivity}\nLicense Type: ${user.licenseType}`);
            }
        }

        // SprintCross Form Submission
        const sprintCrossForm = document.getElementById('sprintCrossForm');
        sprintCrossForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const boardInput = document.getElementById('sprintCrossBoardInput').value.trim();
            if (!boardInput) {
                showSprintCrossError('Please enter a Jira board URL or Board ID.');
                return;
            }
            const boardId = extractBoardIdFromUrl(boardInput);
            if (!boardId) {
                showSprintCrossError('Could not extract board ID from the provided input.');
                return;
            }
            loadSprintCrossDataByBoard(boardId);
        });

        // Helper to extract board ID from URL or input
        function extractBoardIdFromUrl(input) {
            if (/^\d+$/.test(input.trim())) {
                return input.trim();
            }
            const patterns = [
                /\/boards\/(\d+)/,
                /rapidView=(\d+)/,
                /board=(\d+)/,
                /boardId=(\d+)/
            ];
            for (const pattern of patterns) {
                const match = input.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return null;
        }

        // Fetch and display SprintCross data by board
        async function loadSprintCrossDataByBoard(boardId) {
            try {
                // Show progress bar and initialize
                const progressBar = document.getElementById('sprintCrossProgressBar');
                const progressBarFill = document.getElementById('sprintCrossProgressBarFill');
                const progressText = document.getElementById('sprintCrossProgressText');
                
                progressBar.style.display = 'block';
                progressBarFill.style.width = '0%';
                progressText.textContent = 'Initializing request...';
                
                // Simulate progress updates
                const progressSteps = [
                    { progress: 20, text: 'Connecting to JIRA...' },
                    { progress: 40, text: 'Fetching board data...' },
                    { progress: 60, text: 'Analyzing sprint data...' },
                    { progress: 80, text: 'Processing issues...' },
                    { progress: 90, text: 'Generating charts...' }
                ];
                
                let currentStep = 0;
                const progressInterval = setInterval(() => {
                    if (currentStep < progressSteps.length) {
                        const step = progressSteps[currentStep];
                        progressBarFill.style.width = step.progress + '%';
                        progressText.textContent = step.text;
                        currentStep++;
                    }
                }, 300);
                
                const resp = await fetch(`/api/issues/multi_sprint?board_id=${boardId}`);
                clearInterval(progressInterval);
                
                if (!resp.ok) throw new Error('Failed to load SprintCross data');
                
                // Complete progress
                progressBarFill.style.width = '100%';
                progressText.textContent = 'Analysis complete!';
                
                const data = await resp.json();
                displaySprintCrossData(data);
            } catch (e) {
                showSprintCrossError('Failed to load SprintCross data.');
            } finally {
                setTimeout(() => {
                    document.getElementById('sprintCrossProgressBar').style.display = 'none';
                }, 1000);
            }
        }

        // Display SprintCross data
        function displaySprintCrossData(data) {
            console.log('displaySprintCrossData called with:', data);
            const summary = document.getElementById('sprintCrossSummary');
            const breakdowns = document.getElementById('sprintCrossBreakdowns');
            const jiraBtn = document.getElementById('sprintCrossJiraBtn');
            
            console.log('Found elements:', { summary: !!summary, breakdowns: !!breakdowns, jiraBtn: !!jiraBtn });
            
            // Clear previous content
            summary.innerHTML = '';
            breakdowns.style.display = 'none';
            jiraBtn.style.display = 'none';
            
            if (!data || !data.issues || !Array.isArray(data.issues)) {
                console.error('Invalid data structure:', data);
                showSprintCrossError('Invalid data received from server.');
                return;
            }
            
            const issues = data.issues;
            const totalIssues = issues.length;
            
            if (totalIssues === 0) {
                summary.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No issues found in multiple sprints for this board.</div>';
                return;
            }
            
            // Display summary
            summary.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-chart-line me-2"></i>SprintCross Analysis Complete</h6>
                    <p class="mb-0">Found <strong>${totalIssues}</strong> issues that have been in multiple sprints.</p>
                </div>
            `;
            
            // Show JIRA link if available
            if (data.jira_link) {
                jiraBtn.style.display = 'inline-block';
                jiraBtn.onclick = () => window.open(data.jira_link, '_blank');
            }
            
            // Display breakdowns
            displaySprintCrossBreakdowns(data);
            breakdowns.style.display = 'block';
        }
        
        // Display SprintCross breakdowns
        function displaySprintCrossBreakdowns(data) {
            const issues = data.issues;
            // --- Issue Types ---
            const typeCounts = {};
            issues.forEach(issue => {
                const type = issue.issuetype || 'Unknown';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            renderSprintCrossPieChart('sprintCrossTypeChart', typeCounts, 'Issue Types');
            // --- Priority Levels ---
            const priorityCounts = {};
            issues.forEach(issue => {
                const priority = issue.priority || 'Unassigned';
                priorityCounts[priority] = (priorityCounts[priority] || 0) + 1;
            });
            renderSprintCrossPieChart('sprintCrossPriorityChart', priorityCounts, 'Priority Levels');
            // --- Completion Status ---
            const statusCounts = {};
            issues.forEach(issue => {
                const status = issue.status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            renderSprintCrossPieChart('sprintCrossStatusChart', statusCounts, 'Completion Status');
        }

        // Chart.js pie/doughnut chart rendering
        let sprintCrossCharts = {};
        function renderSprintCrossPieChart(canvasId, countsObj, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            // Destroy previous chart if exists
            if (sprintCrossCharts[canvasId]) {
                sprintCrossCharts[canvasId].destroy();
            }
            const labels = Object.keys(countsObj);
            const data = Object.values(countsObj);
            const total = data.reduce((a, b) => a + b, 0);
            
            // Pick a color palette
            const palette = [
                '#36A2EB', '#FF6384', '#4BC0C0', '#FFCE56', '#9966FF', '#FF9F40', '#8BC34A', '#E91E63', '#00BCD4', '#FFC107', '#607D8B', '#795548'
            ];
            const backgroundColors = labels.map((_, i) => palette[i % palette.length]);
            
            sprintCrossCharts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 16,
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percent}%)`;
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    cutout: '65%',
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                },
                
            });
        }

        // Show SprintCross Error
        function showSprintCrossError(message) {
    document.getElementById('sprintCrossProgressBar').style.display = 'none';
    const summary = document.getElementById('sprintCrossSummary');
    summary.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${message}</div>`;
}
    </script>

    <!-- Projects Modal -->
    <div class="modal fade" id="projectsModal" tabindex="-1" aria-labelledby="projectsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectsModalLabel">
                        <i class="fas fa-project-diagram me-2"></i>All Projects
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="projectSearchInput" placeholder="Search projects...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="projectStatusFilter">
                                <option value="all">All Projects</option>
                                <option value="active">Active Projects</option>
                                <option value="inactive">Inactive Projects</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="projectsLoading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span>Loading projects...</span>
                    </div>
                    
                    <div id="projectsError" class="alert alert-danger" style="display: none;"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Project</th>
                                    <th>Key</th>
                                    <th>Type</th>
                                    <th>Last Activity</th>
                                    <th>Days Since Activity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Click "Total Projects" to load data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <small class="text-muted" id="projectsCount">0 projects</small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="refreshProjectsBtn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Modal -->
    <div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="usersModalLabel">
                        <i class="fas fa-users me-2"></i>All Users
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="userSearchInput" placeholder="Search users...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="userStatusFilter">
                                <option value="all">All Users</option>
                                <option value="active">Active Users (30 days)</option>
                                <option value="inactive">Inactive Users (120+ days)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="usersLoading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span>Loading users...</span>
                    </div>
                    
                    <div id="usersError" class="alert alert-danger" style="display: none;"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Last Activity</th>
                                    <th>Days Since Activity</th>
                                    <th>License Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <